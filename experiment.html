<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行为实验</title>
    <style>
        body {
            margin: 1000;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: black;
            color: white;
            font-family: Arial, sans-serif;
        }

        .screen {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .screen.active {
            display: block;
        }

        /* Layout1的样式 */
        .container {
            position: relative;
            width: 1200px;
            height: 800px;
        }

        .panel {
            position: absolute;
            background: #3F3F3F;
            overflow: hidden;
        }

        .left-panel {
            width: 300px;
            height: 180px;
        }

        .left-panel-1 { top: 0; }
        .left-panel-2 { top: 200px; }
        .left-panel-3 { top: 400px; }
        .left-panel-4 { top: 600px; }

        .right-panel {
            width: 940px;
            height: 180px;
            left: 320px;
        }

        .right-panel-1 { top: 0; }
        .right-panel-2 { top: 200px; }
        .right-panel-3 { top: 400px; }

        .bottom-panel {
            width: 300px;
            height: 180px;
            top: 600px;
        }

        .bottom-panel-1 { left: 320px; }
        .bottom-panel-2 { left: 640px; }
        .bottom-panel-3 { left: 960px; }

        .dot-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            gap: 10px;
            padding: 15px;
            box-sizing: border-box;
        }

        .left-panel .dot-grid,
        .bottom-panel .dot-grid {
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }

        .right-panel .dot-grid {
            grid-template-columns: repeat(20, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }

        .dot {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dot::before {
            content: '';
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #828282;
            opacity: 0.5;
        }

        .triangle::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #828282;
            opacity: 0.5;
            transform-origin: center;
            transform: rotate(0deg);
            position: relative;
            display: block;
            margin: auto;
        }

        .fixation {
            font-size: 48px;
            color: white;
        }

        .stimulus {
            margin: 20px auto;
        }

        .question {
            font-size: 24px;
            margin: 20px 0;
        }

        .instruction {
            font-size: 18px;
            line-height: 1.6;
            text-align: left;
        }

        .stimulus-canvas {
            background: white;
            margin: auto;
        }
    </style>
</head>
<body>
    <!-- 指导语界面 -->
    <div id="instruction" class="screen active">
        <div class="instruction">
            <h2>实验指导语</h2>
            <p>欢迎参加本次实验。</p>
            <p>在实验中，你会看到一张填充圆形阵列的图片，中间有些圆形被替换成了三角形。</p>
            <p>你需要在5秒内尽可能记住图片上的内容然后回答问题。</p>
            <p>问题回答规则：</p>
            <ul>
                <li>正确请按 A 键</li>
                <li>错误请按 L 键</li>
            </ul>
            <p>按任意键继续...</p>
        </div>
    </div>

    <!-- 注视点界面 -->
    <div id="fixation" class="screen">
        <div class="fixation">+</div>
    </div>

    <!-- 刺激呈现界面 -->
    <div id="stimulus" class="screen">
        <div class="container">
            <!-- 左侧面板 -->
            <div class="panel left-panel left-panel-1">
                <div class="dot-grid"></div>
            </div>
            <div class="panel left-panel left-panel-2">
                <div class="dot-grid"></div>
            </div>
            <div class="panel left-panel left-panel-3">
                <div class="dot-grid"></div>
            </div>
            <div class="panel left-panel left-panel-4">
                <div class="dot-grid"></div>
            </div>

            <!-- 右侧面板 -->
            <div class="panel right-panel right-panel-1">
                <div class="dot-grid"></div>
            </div>
            <div class="panel right-panel right-panel-2">
                <div class="dot-grid"></div>
            </div>
            <div class="panel right-panel right-panel-3">
                <div class="dot-grid"></div>
            </div>

            <!-- 底部面板 -->
            <div class="panel bottom-panel bottom-panel-1">
                <div class="dot-grid"></div>
            </div>
            <div class="panel bottom-panel bottom-panel-2">
                <div class="dot-grid"></div>
            </div>
            <div class="panel bottom-panel bottom-panel-3">
                <div class="dot-grid"></div>
            </div>
        </div>
    </div>

    <!-- 问题界面 -->
    <div id="question" class="screen">
        <div class="question">
            图中三角形的数量是否大于10？
            <p>正确按A，错误按L</p>
        </div>
    </div>

    <script>
        // 基本变量
        let currentPhase = 'instruction';
        let practiceCount = 0;
        let formalCount = 0;
        let startTime;
        let currentTriangleCount = 0;
        let currentLayout = 1; // 添加布局控制变量
        const results = [];

        // 记录实验结果的函数
        function recordResult(reactionTime) {
            const trialType = practiceCount < 7 ? 'Excise' : 'Test';
            const trialNumber = (practiceCount < 7 ? practiceCount + 1 : formalCount + 1)
                .toString()
                .padStart(2, '0');
            
            results.push({
                layout: `Layout${currentLayout}`,
                trial: `${trialType}${trialNumber}`,
                reactionTime: reactionTime,
                response: lastResponse.toUpperCase()
            });
        }

        // 导出CSV文件
        function exportToCSV() {
            let csvContent = "\ufeff布局,实验次序,反应时间(ms),用户作答\n";
            
            results.forEach(result => {
                csvContent += `${result.layout},${result.trial},${result.reactionTime},${result.response}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `experiment_results_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 基本函数
        function showScreen(screenId) {
            console.log('切换到屏幕:', screenId); // 调试日志
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showFixation() {
            console.log('显示注视点'); // 调试日志
            showScreen('fixation');
            setTimeout(() => {
                showStimulus();
            }, 1000);
        }

        function startExperiment() {
            console.log('开始实验'); // 调试日志
            currentPhase = 'experiment';
            showFixation();
        }

        function generateStimulus() {
            // 根据当前布局选择不同的面板配置
            const layouts = {
                1: { rightPanel: 20, leftPanel: 6 },
                2: { leftPanel: 20, rightPanel: 6 },
                3: { bottomPanel: 28, topPanel: 4 },
                4: { leftPanel: 21, rightPanel: 10, topPanel: 4 }
            };

            const currentConfig = layouts[currentLayout];
            
            document.querySelectorAll('.dot-grid').forEach(grid => {
                grid.innerHTML = '';
                const parentClassList = grid.parentElement.classList;
                let columns = 6; // 默认值

                // 根据当前布局和面板类型设置列数
                if (currentLayout === 1) {
                    columns = parentClassList.contains('right-panel') ? 20 : 6;
                } else if (currentLayout === 2) {
                    columns = parentClassList.contains('left-panel') ? 20 : 6;
                } else if (currentLayout === 3) {
                    columns = parentClassList.contains('bottom-panel') ? 28 : 4;
                } else if (currentLayout === 4) {
                    if (parentClassList.contains('left-panel')) columns = 21;
                    else if (parentClassList.contains('right-panel')) columns = 10;
                    else if (parentClassList.contains('top-panel')) columns = 4;
                }

                const rows = 4;
                const total = columns * rows;
                
                for (let i = 0; i < total; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    grid.appendChild(dot);
                }
            });

            const numberOfTriangles = Math.floor(Math.random() * 15) + 5;
            const allDots = Array.from(document.querySelectorAll('.dot'));
            const shuffled = allDots.sort(() => Math.random() - 0.5);
            
            shuffled.slice(0, numberOfTriangles).forEach(dot => {
                dot.classList.remove('dot');
                dot.classList.add('triangle');
            });

            return numberOfTriangles;
        }

        function showStimulus() {
            showScreen('stimulus');
            currentTriangleCount = generateStimulus();
            console.log('当前三角形数量:', currentTriangleCount);
            setTimeout(() => {
                showBlackScreen();
            }, 1000);
        }

        function showBlackScreen() {
            document.body.style.backgroundColor = 'black';
            setTimeout(() => {
                showQuestion();
            }, 500);
        }

        function showQuestion() {
            showScreen('question');
            startTime = Date.now();
        }

        // 更新handleResponse函数
        let lastResponse = '';
        function handleResponse(key) {
            if (key === 'a' || key === 'l') {
                const reactionTime = Date.now() - startTime;
                lastResponse = key;
                
                recordResult(reactionTime);

                if (practiceCount < 7) {
                    practiceCount++;
                    if (practiceCount === 7) {
                        alert('练习结束，即将进入正式实验');
                    }
                    showFixation();
                } else if (formalCount < 3) {
                    formalCount++;
                    if (formalCount === 3) {
                        if (currentLayout < 4) {
                            // 切换到下一个布局
                            currentLayout++;
                            practiceCount = 0;
                            formalCount = 0;
                            alert(`实验${currentLayout-1}结束，即将开始实验${currentLayout}`);
                            showFixation();
                        } else {
                            // 所有实验结束
                            alert('所有实验结束！即将导出结果文件。');
                            exportToCSV();
                            return;
                        }
                    } else {
                        showFixation();
                    }
                }
            }
        }

        // 按键事件处理
        window.onkeydown = function(event) {
            console.log('按键被按下:', event.key);
            
            if (currentPhase === 'instruction') {
                startExperiment();
                return;
            }
            
            if (currentPhase === 'experiment' && 
                document.getElementById('question').classList.contains('active')) {
                if (event.key.toLowerCase() === 'a' || event.key.toLowerCase() === 'l') {
                    handleResponse(event.key.toLowerCase());
                }
            }
        };

        // 初始化
        window.onload = function() {
            console.log('页面加载完成');
            showScreen('instruction');
            currentPhase = 'instruction';
        };
    </script>
</body>
</html> 