<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>趋势图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            width: 1280px;
            height: 800px;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        .container {
            position: relative;
            margin: 24px 24px;
            width: 1200px;
            height: 800px;
        }

        /* 左侧数据面板样式 */
        .data-panel {
            position: absolute;
            width: 300px;
            height: 200px;
            background: #3F3F3F;
            left: 0;
        }

        .data-panel.spo2 {
            top: 0;
        }

        .data-panel.hr {
            top: 210px;
        }

        .data-panel.bp {
            top: 420px;
            height: 300px;
        }

        .data-panel.temp {
            top: 730px;
        }

        /* 数据面板内部布局 */
        .panel-content {
            padding: 5px 10px;
        }

        .metric-header {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
        }

        .metric-name {
            font-size: 16px;
            line-height: 20px;
        }

        .metric-container {
            display: grid; /* 父容器设置为 Grid 容器 */
            grid-template-columns: repeat(3, auto); /* 改为三列以适应分隔符 */
            justify-items: center; /* 让子元素内容居中 */
            align-items: center; /* 让子元素内容垂直居中 */
            gap: 0px; /* 设置元素之间的间隔距离 */
        }

        .metric-separator { 
            /* 用于分隔符的样式 */
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
        }

        .metric-value-BP {
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
        }

        .metric-value {
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
            text-align: center;
            width: 100%;
            display: flex; /* 使用 Flexbox 实现垂直居中 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
        }

        .scale-container {
            position: relative;
            top: -30px;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scale-values {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* 这行将所有子元素右对齐 */
        }

        .scale-value {
            font-size: 12px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .scale-value-spo2-1 {
            top: -5px;
        }
        
        .scale-value-spo2-2 {
            top: -5px;
        }

        .scale-value-spo2-3 {
            top: 65px;
        }

        .scale-value-hr-1 {
            top: -5px;
        }

        .scale-value-hr-2 {
            top: -5px;
        }

        .scale-value-hr-3 {
            top: -5px;
        }
        
        .scale-value-hr-4 {
            top: 5px;
        }
        
        .scale-value-hr-5 {
            top: 5px;
        }
        
        .scale-value-hr-6 {
            top: 20px;
        }

        .scale-value-bp1-1 {
            top: -5px;
        }

        .scale-value-bp1-2 {
            top: 10px;
        }

        .scale-value-bp1-3 {
            top: 10px;
        }
        
        .scale-value-bp1-4 {
            top: 12px;
        }
        
        .scale-value-bp1-5 {
            top: 10px;
        }

        .scale-value-bp1-6 {
            top: 21px;
        }

        .scale-value-bp2-1 {
            top: -5px;
        }

        .scale-value-bp2-2 {
            top: 30px;
        }

        .scale-value-bp2-3 {
            top: 28px;
        }
        
        .scale-value-bp2-4 {
            top: 26px;
        }
        
        .scale-value-bp2-5 {
            top: 25px;
        }

        .scale-value-bp2-6 {
            top: 23px;
        }

        .scale-value-temp-1 {
            top: -5px;
        }

        .scale-value-temp-2 {
            top: 20px;
        }

        .scale-value-temp-3 {
            top: 20px;
        }
        
        .scale-value-temp-4 {
            top: 20px;
        }

        .scale-value-temp-5 {
            top: 20px;
        }

        .scale-value-temp-6 {
            top: 25px;
        }

        .trend-line {
            position: relative;
            width: 300px;
            height: 100px;
            overflow: visible;
        }

        /* 点和线的样式 */
        .trend-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #D9D9D9;
            border-radius: 50%;
        }

        .trend-segment {
            position: absolute;
            height: 1.5px;
            background: #fff;
            transform-origin: left center;
        }

        /* 添加CSS样式 */
        .baseline {
            position: absolute;
            width: 100%;
            height: 30%;
            opacity: 0.1;
        }
        .baseline.red {
            background: #FF5555;
        }
        .baseline.yellow {
            background: #FFD700;
        }
        .baseline.green {
            background: #00C764;
        }

        .line-divider {
            position: absolute;
            left: 30px;
            top: 189px;
            height: 1px;
            background-color: white;
            width: 90%;
        }

        .patient-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .patient-button {
            padding: 5px 10px;
            background: #3F3F3F;
            color: white;
            border: 1px solid #555;
            cursor: pointer;
        }

        .patient-button:hover {
            background: #4F4F4F;
        }

        .patient-button.selected {
            background: #5F5F5F;
            border: 2px solid #00FF00;
        }

        /* 当前病人信息容器 */
        .current-patient {
            position: fixed;
            top: 10px;
            right: 150px;
            background: #3F3F3F;
            padding: 10px;
            color: white;
            border: 1px solid #555;
            width: 250px; /* 稍微加宽以容纳两列 */
            display: none; /* 默认隐藏 */
        }

        .current-patient h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            text-align: center;
        }

        .current-patient .patient-data {
            display: flex;
            justify-content: space-between;
        }

        .current-patient .column {
            flex: 1;
            padding: 0 10px;
        }

        .current-patient p {
            margin: 5px 0;
            font-size: 14px;
        }

        .current-patient .label {
            font-weight: bold;
            color: #00FF00;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SpO2数据面板 -->
        <div class="data-panel spo2">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">SpO2</div>
                </div>

                <div class="metric-value">98</div>
                
                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-spo2-1">100</div>
                        <div class="scale-value scale-value-spo2-2">90</div>
                        <div class="scale-value scale-value-spo2-3">0</div>
                    </div>

                    <div class="trend-line" id="spo2-trend"></div>
                </div>
            </div>
        </div>

        <!-- HR数据面板 -->
        <div class="data-panel hr">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">HR</div>
                </div>

                <div class="metric-value">72</div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-hr-1">140</div>
                        <div class="scale-value scale-value-hr-2">120</div>
                        <div class="scale-value scale-value-hr-3">100</div>
                        <div class="scale-value scale-value-hr-4">60</div>
                        <div class="scale-value scale-value-hr-5">50</div>
                        <div class="scale-value scale-value-hr-6">0</div>
                    </div>

                    <div class="trend-line" id="hr-trend"></div>
                </div>
            </div>
        </div>

        <!-- BP数据面板 -->
        <div class="data-panel bp">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">BP</div>
                </div>
                
                <div class="metric-container">
                    <div class="metric-value-BP">35</div>
                    <div class="metric-separator">/</div>
                    <div class="metric-value-BP">80</div>
                </div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-bp1-1">180</div>
                        <div class="scale-value scale-value-bp1-2">140</div>
                        <div class="scale-value scale-value-bp1-3">120</div>
                        <div class="scale-value scale-value-bp1-4">100</div>
                        <div class="scale-value scale-value-bp1-5">90</div>
                        <div class="scale-value scale-value-bp1-6">50</div>
                    </div>
                   
                    <div class="trend-line" id="bp-trend1"></div>
                </div>

                <!-- 分割线 -->
                <div class="line-divider"></div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-bp2-1">130</div>
                        <div class="scale-value scale-value-bp2-2">90</div>
                        <div class="scale-value scale-value-bp2-3">80</div>
                        <div class="scale-value scale-value-bp2-4">70</div>
                        <div class="scale-value scale-value-bp2-5">60</div>
                        <div class="scale-value scale-value-bp2-6">50</div>
                    </div>

                    <div class="trend-line" id="bp-trend2"></div>
                </div>

            </div>
        </div>

        <!-- TEMP数据面板 -->
        <div class="data-panel temp">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">TEMP</div>
                </div>

                <div class="metric-value">37.2</div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-temp-1">42</div>
                        <div class="scale-value scale-value-temp-2">38</div>
                        <div class="scale-value scale-value-temp-3">37.3</div>
                        <div class="scale-value scale-value-temp-4">36</div>
                        <div class="scale-value scale-value-temp-5">35.5</div>
                        <div class="scale-value scale-value-temp-6">33</div>
                    </div>

                    <div class="trend-line" id="temp-trend"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加病人选择按钮 -->
    <div class="patient-buttons">
        <button class="patient-button" onclick="selectPatient(1)">Patient 1恶化</button>
        <button class="patient-button" onclick="selectPatient(2)">Patient 2恶化</button>
        <button class="patient-button" onclick="selectPatient(3)">Patient 3恶化</button>
        <button class="patient-button" onclick="selectPatient(4)">Patient 4恶化</button>
        <button class="patient-button" onclick="selectPatient(5)">Patient 5恶化</button>
        <button class="patient-button" onclick="selectPatient(6)">Patient 6恶化</button>
        <button class="patient-button" onclick="selectPatient(7)">Patient 1好转</button>
        <button class="patient-button" onclick="selectPatient(8)">Patient 2好转</button>
        <button class="patient-button" onclick="selectPatient(9)">Patient 3好转</button>
        <button class="patient-button" onclick="selectPatient(10)">Patient 4好转</button>
        <button class="patient-button" onclick="selectPatient(11)">Patient 5好转</button>
        <button class="patient-button" onclick="selectPatient(12)">Patient 6好转</button>
    </div>

    <div class="current-patient">
        <h3>Current Patient</h3>
        <div class="patient-data">
            <div class="column">
                <p class="label">Initial Values</p>
                <p>HR: <span id="initial-hr"></span></p>
                <p>SpO2: <span id="initial-spo2"></span></p>
                <p>BP: <span id="initial-bp1"></span>/<span id="initial-bp2"></span></p>
                <p>Temp: <span id="initial-temp"></span></p>
            </div>
            <div class="column">
                <p class="label">Target Values</p>
                <p>HR: <span id="target-hr"></span></p>
                <p>SpO2: <span id="target-spo2"></span></p>
                <p>BP: <span id="target-bp1"></span>/<span id="target-bp2"></span></p>
                <p>Temp: <span id="target-temp"></span></p>
            </div>
        </div>
    </div>

    <script>
        function createTrendLine(containerId, points) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 修改metric判断逻辑
            let metric = containerId.split('-')[0];
            if (containerId.includes('bp-trend1')) {
                metric = 'Pleth_bp1';
            } else if (containerId.includes('bp-trend2')) {
                metric = 'Pleth_bp2';
            }

            // 添加基线
            switch(metric) {
                case 'spo2':
                    // SPO2: 85-90红色(5), 90-100绿色(10)
                    addBaseline(container, 'red', 0/100, 90/100);     // 0-90
                    addBaseline(container, 'green', 90/100, 100/100);   // 90-100
                    break;
                case 'hr':
                    // HR: 0-50红色(50/140), 50-60黄色(10/140), 60-100绿色(40/140), 100-120黄色(20/140), 120-140红色(20/140)
                    addBaseline(container, 'red', 0/140, 50/140);      // 0-50
                    addBaseline(container, 'yellow', 50/140, 60/140); // 50-60
                    addBaseline(container, 'green', 60/140, 100/140);  // 60-100
                    addBaseline(container, 'yellow', 100/140, 120/140); // 100-120
                    addBaseline(container, 'red', 120/140, 140/140);      // 120-140
                    break;
                case 'Pleth_bp1':
                    // BP1: 50-90红色, 90-100黄色, 100-120绿色, 120-140黄色, 140-180红色
                    addBaseline(container, 'red', (50 - 50) / (180 - 50) , (90 - 50) / (180 - 50));    // 50-90
                    addBaseline(container, 'yellow', (90 - 50) / (180 - 50) , (100 - 50) / (180 - 50));    // 90-100
                    addBaseline(container, 'green', (100 - 50) / (180 - 50) , (120 - 50) / (180 - 50));    // 100-120
                    addBaseline(container, 'yellow', (120 - 50) / (180 - 50) , (140 - 50) / (180 - 50));    // 120-140
                    addBaseline(container, 'red', (140 - 50) / (180 - 50) , (180 - 50) / (180 - 50));    // 140-180
                    break;
                case 'Pleth_bp2':
                    // BP2: 50-60红色, 60-70黄色, 70-80绿色, 80-90黄色, 90-130红色
                    addBaseline(container, 'red', (50 - 50) / (130 - 50) , (60 - 50) / (130 - 50));    // 50-60
                    addBaseline(container, 'yellow', (60 - 50) / (130 - 50) , (70 - 50) / (130 - 50));    // 60-70
                    addBaseline(container, 'green', (70 - 50) / (130 - 50) , (80 - 50) / (130 - 50));    // 70-80
                    addBaseline(container, 'yellow', (80 - 50) / (130 - 50) , (90 - 50) / (130 - 50));    // 80-90
                    addBaseline(container, 'red', (90 - 50) / (130 - 50) , (130 - 50) / (130 - 50));    // 90-130
                    break;
                case 'temp':
                    // TEMP: 35.5-36红色(0.5), 36-37.5绿色(1.5), 37.5-38.5红色(1)
                    addBaseline(container, 'red', (33 - 33) / (42 - 33) , (35.5 - 33) / (42 - 33));    // 33-35.5
                    addBaseline(container, 'yellow', (35.5 - 33) / (42 - 33) , (36 - 33) / (42 - 33));    // 35.5-36
                    addBaseline(container, 'green', (36 - 33) / (42 - 33) , (37.3 - 33) / (42 - 33));    // 36-37.5
                    addBaseline(container, 'yellow', (37.3 - 33) / (42 - 33) , (38 - 33) / (42 - 33));    // 37.5-38
                    addBaseline(container, 'red', (38 - 33) / (42 - 33) , (42 - 33) / (42 - 33));    // 38-442
                    break;
            }

            // 创建点和线
            points.forEach((point, index) => {
                const dot = document.createElement('div');
                dot.className = 'trend-dot';
                dot.style.left = `${point.x}px`;
                dot.style.top = `${point.y - 3}px`;
                
                // 直接使用修正后的metric获取值
                const value = dataQueue[metric][index];
                
                switch(metric) {
                    case 'spo2':
                        // SPO2: <90红色, 90-100绿色
                        if (value < 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'hr':
                        // HR: <50红色, 50-60黄色, 60-100绿色, 100-120黄色, >120红色
                        if (value < 50 || value > 120) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 50 && value < 60) || (value >= 100 && value <= 120)) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'Pleth_bp1':
                        // BP1: 50-90红色, 90-100黄色, 10-120绿色, 120-140黄色, 140-180红色
                        if (value < 90 || value > 140) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 90 && value < 100) || (value > 120 && value <= 140)) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'Pleth_bp2':
                        // BP2: 50-60红色, 60-70黄色, 70-80绿色, 80-90黄色, 90-130红色
                        if (value < 60 || value > 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 60 && value < 70) || value > 80 && value <= 90) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'temp':
                        // TEMP: 33-35.5红色, 35.5-36黄色,36-37.3绿色, 37.3-38黄色, 38-42红色
                        if (value < 35.5 || value > 38) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 35.5 && value < 36) || value > 37.3 && value <= 38) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    default:
                        dot.style.background = '#D9D9D9';
                }
                
                container.appendChild(dot);

                // 创建连接线
                if (index < points.length - 1) {
                    const nextPoint = points[index + 1];
                    const segment = document.createElement('div');
                    segment.className = 'trend-segment';
                    
                    // 计算线段长度和角度
                    const length = Math.sqrt(
                        Math.pow(nextPoint.x - point.x, 2) + 
                        Math.pow(nextPoint.y - point.y, 2)
                    );
                    const angle = Math.atan2(
                        nextPoint.y - point.y,
                        nextPoint.x - point.x
                    ) * 180 / Math.PI;

                    segment.style.width = `${length}px`;
                    segment.style.transform = `rotate(${angle}deg)`;
                    segment.style.left = `${point.x}px`;
                    segment.style.top = `${point.y + dot.offsetHeight / 2 - 3}px`;
                    
                    // 设置线段颜色与点的颜色相同
                    segment.style.background = dot.style.background;
                    
                    container.appendChild(segment);
                }
            });
        }

        // 添加基线的辅助函数
        function addBaseline(container, color, startPercent, endPercent) {
            const baseline = document.createElement('div');
            baseline.className = `baseline ${color}`;
            baseline.style.bottom = `${startPercent * 100}%`;
            baseline.style.height = `${(endPercent - startPercent) * 100}%`;
            container.appendChild(baseline);
        }

        // 存储过去25秒的数据队列
        const dataQueue = {
            spo2: [],
            hr: [],
            Pleth_bp1: [],
            Pleth_bp2: [],
            temp: []
        };

        // 存储 5 秒的平均值
        const dataArray = {
            spo2: [],
            hr: [],
            Pleth_bp1: [],
            Pleth_bp2: [],
            temp: []
        };

        // 添加趋势控制系统
        const trendControl = {
            duration: 120,  // 2分钟 = 120秒
            startTime: null,
            initialValues: {
                spo2: 80,
                hr: 40,
                Pleth_bp1: 70,
                Pleth_bp2: 50,
                temp: 35.5
            },
            targetValues: {
                spo2: 90,
                hr: 130,
                Pleth_bp1: 160,
                Pleth_bp2: 100,
                temp: 38.0
            },
            isTransitioning: false
        };

        // 计算平滑过渡值的函数
        function calculateTransitionValue(initial, target, progress) {
            // 使用缓动函数使变化更自然
            progress = Math.sin(progress * Math.PI / 2);
            return initial + (target - initial) * progress;
        }

        // 生成随机数据的函数
        function generateRandomData() {
            if (!trendControl.isTransitioning) {
            return {
                    spo2: trendControl.initialValues.spo2,
                    hr: trendControl.initialValues.hr,
                    Pleth_bp1: trendControl.initialValues.Pleth_bp1,
                    Pleth_bp2: trendControl.initialValues.Pleth_bp2,
                    temp: trendControl.initialValues.temp
                };
            }

            const currentTime = Date.now();
            const progress = Math.min((currentTime - trendControl.startTime) / (trendControl.duration * 1000), 1);

            const result = {};
            Object.keys(trendControl.initialValues).forEach(metric => {
                const initial = trendControl.initialValues[metric];
                const target = trendControl.targetValues[metric];
                const baseValue = calculateTransitionValue(initial, target, progress);

                // 根据当前值和目标值之间的差值来决定波动范围
                let fluctuation;
                if (progress < 1) { // 如果还未完成过渡
                    fluctuation = Math.abs(baseValue - target) * 0.1; // 波动范围为差值的10%
                } else {
                    fluctuation = 0; // 最后一次更新直接设置为目标值
                }

                // 计算新值
                let newValue = baseValue + (Math.random() * 2 - 1) * fluctuation; // 随机增加或减少
                
                // 确保温度保留一位小数，其他指标取整
                if (metric === 'temp') {
                    result[metric] = parseFloat(newValue.toFixed(1));
                } else {
                    result[metric] = Math.floor(newValue);
                }
                
                // 当过渡结束时，确保值为目标值
                if (progress >= 1) {
                    result[metric] = target;
                }
            });

            if (progress >= 1) {
                trendControl.isTransitioning = false;
            }

            return result;
        }

        // 更新数据面板显示值
        function updatePanelValues(data) {
            document.querySelector('.data-panel.spo2 .metric-value').textContent = data.spo2;
            document.querySelector('.data-panel.hr .metric-value').textContent = data.hr;
            // 更新BP面板的两个值
            const bpValues = document.querySelectorAll('.data-panel.bp .metric-value-BP');
            bpValues[0].textContent = data.Pleth_bp1;
            bpValues[1].textContent = data.Pleth_bp2;
            document.querySelector('.data-panel.temp .metric-value').textContent = data.temp;
        }

        // 更新趋势图
        function updateTrendLines() {
            const containerWidth = 300;
            let containerHeight = 100;
            
            Object.keys(dataQueue).forEach(metric => {
                let containerId = `${metric}-trend`;
                if (metric === 'Pleth_bp1') {
                    containerId = 'bp-trend1';
                } else if (metric === 'Pleth_bp2') {
                    containerId = 'bp-trend2';
                }
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                const points = dataQueue[metric].map((value, index) => {
                    const x = (index / 5) * 240;
                    let y;
                    
                    switch(metric) {
                        case 'spo2':
                            const spo2_totalRange = 100; // 总范围是0到100

                            if (value < 90) { // 红色区域 (0-90)
                                // 计算在0到90之间的比例位置
                                const position = value / 90;
                                y = containerHeight * (1 - (position * (90 / spo2_totalRange))); // 映射到0到90/100之间
                            } else { // 绿色区域 (90-100)
                                // 计算在90到100之间的比例位置
                                const position = (value - 90) / (100 - 90);
                                y = containerHeight * (1 - ((position * (10 / spo2_totalRange)) + (90 / spo2_totalRange))); // 映射到90/100到100/100之间
                            }
                            break;
                        case 'hr':
                            const hr_totalRange = 140; // 总范围

                            if (value <= 50) { // 红色区域 (0-50)
                                // 计算在0到50之间的比例位置
                                const position = value / 50;
                                y = containerHeight * (1 - (position * (50 / hr_totalRange))); // 落在0到50/140之间
                            } else if (value <= 60) { // 黄色区域 (50-60)
                                // 计算在50到60之间的比例位置
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (1 - ((position * (10 / hr_totalRange)) + (50 / hr_totalRange))); // 落在50/140到60/140之间
                            } else if (value <= 100) { // 绿色区域 (60-100)
                                // 计算在60到100之间的比例位置
                                const position = (value - 60) / (100 - 60);
                                y = containerHeight * (1 - ((position * (40 / hr_totalRange)) + (60 / hr_totalRange))); // 落在60/140到100/140之间
                            } else if (value <= 120) { // 黄色区域 (100-120)
                                // 计算在100到120之间的比例位置
                                const position = (value - 100) / (120 - 100);
                                y = containerHeight * (1 - ((position * (20 / hr_totalRange)) + (100 / hr_totalRange))); // 落在100/140到120/140之间
                            } else { // 红色区域 (120-140)
                                // 计算在120到140之间的比例位置
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (1 - ((position * (20 / hr_totalRange)) + (120 / hr_totalRange))); // 落在120/140到140/140之间
                            }
                            break;
                        case 'Pleth_bp1':
                            const bpv1_totalRange = 180 - 50; // 总范围是从50到180

                            if (value <= 90) { // 红色区域 (50-90)
                                // 计算在50到90之间的比例位置
                                const position = (value - 50) / (90 - 50);
                                y = containerHeight * (1 - position * ((90 - 50) / bpv1_totalRange)); // 映射到从顶部到底部的比例
                            } else if (value <= 100) { // 黄色区域 (90-100)
                                // 计算在90到100之间的比例位置
                                const position = (value - 90) / (100 - 90);
                                y = containerHeight * (1 - (((position * (100 - 90) / bpv1_totalRange)) + ((90 - 50) / bpv1_totalRange))); // 加上前两段的比例
                            } else if (value <= 120) { // 绿色区域 (100-120)
                                // 计算在100到120之间的比例位置
                                const position = (value - 100) / (120 - 100);
                                y = containerHeight * (1 - (((position * (120 - 100) / bpv1_totalRange)) + ((100 - 50) / bpv1_totalRange))); // 加上前一段的比例
                            } else if (value <= 140) { // 黄色区域 (120-140)
                                // 计算在120到140之间的比例位置
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (1 - (((position * (140 - 120) / bpv1_totalRange)) + ((120 - 50) / bpv1_totalRange))); // 加上前两段的比例
                            } else { // 红色区域 (140-180)
                                // 计算在140到180之间的比例位置
                                const position = (value - 140) / (180 - 140);
                                y = containerHeight * (1 - (((position * (180 - 140) / bpv1_totalRange)) + ((140 - 50) / bpv1_totalRange))); // 加上前三段的比例
                            }
                            break;
                        case 'Pleth_bp2':
                            const bpv2_totalRange = 130 - 50; // 总范围是从50到130

                            if (value <= 60) { // 第一个区间 (50-60)
                                // 计算在50到60之间的比例位置
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (1 - position * ((60 - 50) / bpv2_totalRange)); // 映射到从顶部到底部的比例
                            } else if (value <= 70) { // 第二个区间 (60-70)
                                // 计算在60到70之间的比例位置
                                const position = (value - 60) / (70 - 60);
                                y = containerHeight * (1 - (((position * (70 - 60) / bpv2_totalRange)) + ((60 - 50) / bpv2_totalRange))); // 加上前两段的比例
                            } else if (value <= 80) { // 第三个区间 (70-80)
                                // 计算在70到80之间的比例位置
                                const position = (value - 70) / (80 - 70);
                                y = containerHeight * (1 - (((position * (80 - 70) / bpv2_totalRange)) + ((70 - 50) / bpv2_totalRange))); // 加上前一段的比例
                            } else if (value <= 90) { // 第四个区间 (80-90)
                                // 计算在80到90之间的比例位置
                                const position = (value - 80) / (90 - 80);
                                y = containerHeight * (1 - (((position * (90 - 80) / bpv2_totalRange)) + ((80 - 50) / bpv2_totalRange))); // 加上前两段的比例
                            } else { // 第五个区间 (90-130)
                                // 计算在90到130之间的比例位置
                                const position = (value - 90) / (130 - 90);
                                y = containerHeight * (1 - (((position * (130 - 90) / bpv2_totalRange)) + ((90 - 50) / bpv2_totalRange))); // 加上前三段的比例
                            }
                            break;
                        case 'temp':
                            const temp_totalRange = 42 - 33; // 总范围

                            if (value <= 35.5) {
                                // 计算在33到35.5之间的比例位置
                                const position = (value - 33) / (35.5 - 33);
                                y = containerHeight * (1 - ((position * 2.5) / temp_totalRange));
                            } else if (value <= 36) {
                                // 计算在35.5到36之间的比例位置
                                const position = (value - 35.5) / (36 - 35.5);
                                y = containerHeight * (1 - (((position * 0.5) / temp_totalRange) + (2.5 / temp_totalRange)));
                            } else if (value <= 37.3) {
                                // 计算在36到37.3之间的比例位置
                                const position = (value - 36) / (37.3 - 36);
                                y = containerHeight * (1 - (((position * 1.3) / temp_totalRange) + ((0.5 + 2.5) / temp_totalRange)));
                            } else if (value <= 38) {
                                // 计算在37.3到38之间的比例位置
                                const position = (value - 37.3) / (38 - 37.3);
                                y = containerHeight * (1 - (((position * 0.7) / temp_totalRange) + ((1.3 + 0.5 + 2.5) / temp_totalRange)));
                            } else {
                                // 计算在38到42之间的比例位置
                                const position = (value - 38) / (42 - 38);
                                y = containerHeight * (1 - (((position * 4) / temp_totalRange) + ((0.7 + 1.3 + 0.5 + 2.5) / temp_totalRange)));
                            }
                            break;
                    }
                    
                    return {x, y: Math.max(0, Math.min(containerHeight, y))};
                });
                
                createTrendLine(containerId, points);
            });
        }

        function calculateAverage(dataArray) {
            const sum = dataArray.reduce((acc, curr) => acc + curr, 0);
            return sum / dataArray.length;
        }
        
        // 更新显示数据
        function updateMetricValues() {
            const newData = generateRandomData();
            // 将新数据添加到 dataArray 中对应指标的数组尾部
            Object.keys(newData).forEach(metric => {
                if (dataArray[metric].length > 5) dataArray[metric].shift(); // 当数据量超过5时，移除最早的数据
                dataArray[metric].push(newData[metric]); // 新数据添加到尾部
            });
            // 只更新显示值
            updatePanelValues(newData);
        }

        // 更新趋势数据
        function updateTrendData() {
            const avgData = {};
            // 对于每个度量，计算其最近5次数据的平均值
            Object.keys(dataArray).forEach(metric => {
                avgData[metric] = calculateAverage(dataArray[metric]);
                // 清空该指标的队列，为下次计算准备
                dataArray[metric] = [];
            });

            let newData = avgData;
            // 更新数据队列和趋势图
            Object.keys(newData).forEach(metric => {
                if (dataQueue[metric].length > 5) dataQueue[metric].shift(); // 当数据量超过5时，移除最早的数据
                dataQueue[metric].push(newData[metric]); // 新数据添加到尾部
            });
            
            // 更新趋势图
            updateTrendLines();
        }

        updateTrendLines();
        
        // 病人数据
        const patientData = {
            patient1: {
                initial: {
                    hr: 110,
                    spo2: 94,
                    Pleth_bp1: 100,
                    Pleth_bp2: 60,
                    temp: 37.0
                },
                target: {
                    hr: 130,
                    spo2: 88,
                    Pleth_bp1: 85,
                    Pleth_bp2: 50,
                    temp: 37.2
                }
            },
            patient2: {
                initial: {
                    hr: 95,
                    spo2: 88,
                    Pleth_bp1: 110,
                    Pleth_bp2: 65,
                    temp: 37.5
                },
                target: {
                    hr: 105,
                    spo2: 80,
                    Pleth_bp1: 105,
                    Pleth_bp2: 60,
                    temp: 37.8
                }
            },
            patient3: {
                initial: {
                    hr: 100,
                    spo2: 92,
                    Pleth_bp1: 90,
                    Pleth_bp2: 55,
                    temp: 38.5
                },
                target: {
                    hr: 120,
                    spo2: 88,
                    Pleth_bp1: 75,
                    Pleth_bp2: 45,
                    temp: 39.0
                }
            },
            patient4: {
                initial: {
                    hr: 85,
                    spo2: 96,
                    Pleth_bp1: 140,
                    Pleth_bp2: 85,
                    temp: 36.8
                },
                target: {
                    hr: 90,
                    spo2: 95,
                    Pleth_bp1: 150,
                    Pleth_bp2: 90,
                    temp: 37.2
                }
            },
            patient5: {
                initial: {
                    hr: 75,
                    spo2: 98,
                    Pleth_bp1: 120,
                    Pleth_bp2: 70,
                    temp: 36.5
                },
                target: {
                    hr: 110,
                    spo2: 90,
                    Pleth_bp1: 90,
                    Pleth_bp2: 50,
                    temp: 37.0
                }
            },
            patient6: {
                initial: {
                    hr: 80,
                    spo2: 97,
                    Pleth_bp1: 110,
                    Pleth_bp2: 70,
                    temp: 37.0
                },
                target: {
                    hr: 90,
                    spo2: 96,
                    Pleth_bp1: 100,
                    Pleth_bp2: 65,
                    temp: 38.0
                }
            },
            patient7: {
                initial: {
                    hr: 130,
                    spo2: 88,
                    Pleth_bp1: 85,
                    Pleth_bp2: 50,
                    temp: 37.2
                },
                target: {
                   
                    hr: 110,
                    spo2: 94,
                    Pleth_bp1: 100,
                    Pleth_bp2: 60,
                    temp: 37.0
                }
            },
            patient8: {
                initial: {
                    hr: 105,
                    spo2: 80,
                    Pleth_bp1: 105,
                    Pleth_bp2: 60,
                    temp: 37.8
                },
                target: {
                    
                    hr: 95,
                    spo2: 88,
                    Pleth_bp1: 110,
                    Pleth_bp2: 65,
                    temp: 37.5
                }
            },
            patient9: {
                initial: {
                    hr: 120,
                    spo2: 88,
                    Pleth_bp1: 75,
                    Pleth_bp2: 45,
                    temp: 39.0
                },
                target: {
                    
                    hr: 100,
                    spo2: 92,
                    Pleth_bp1: 90,
                    Pleth_bp2: 55,
                    temp: 38.5
                }
            },
            patient10: {
                initial: {
                    hr: 90,
                    spo2: 95,
                    Pleth_bp1: 150,
                    Pleth_bp2: 90,
                    temp: 37.2
                },
                target: {
                    
                    hr: 85,
                    spo2: 96,
                    Pleth_bp1: 140,
                    Pleth_bp2: 85,
                    temp: 36.8
                }
            },
            patient11: {
                initial: {
                    hr: 110,
                    spo2: 90,
                    Pleth_bp1: 90,
                    Pleth_bp2: 50,
                    temp: 37.0
                },
                target: {
                    
                    hr: 75,
                    spo2: 98,
                    Pleth_bp1: 120,
                    Pleth_bp2: 70,
                    temp: 36.5
                }
            },
            patient12: {
                initial: {
                    hr: 90,
                    spo2: 96,
                    Pleth_bp1: 100,
                    Pleth_bp2: 65,
                    temp: 38.0
                },
                target: {
                    
                    hr: 80,
                    spo2: 97,
                    Pleth_bp1: 110,
                    Pleth_bp2: 70,
                    temp: 37.0
                }
            }
        };

        // 用于存储定时器的 ID
        let metricIntervalId = null;
        let trendIntervalId = null;

        // 选择病人函数
        function selectPatient(patientNumber) {
            const patient = patientData[`patient${patientNumber}`];

            // 清除所有按钮的选中状态
            document.querySelectorAll('.patient-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 设置当前按钮为选中状态
            event.target.classList.add('selected');
            
            // 1. 清空 dataQueue 和 dataArray 的所有数据
            for (const key in dataQueue) {
                dataQueue[key] = [];
            }
            for (const key in dataArray) {
                dataArray[key] = [];
            }

            // 2. 重置 trendControl 参数并导入 patient.initial 和 patient.target 的数据
            trendControl.initialValues = {...patient.initial};
            trendControl.targetValues = {...patient.target};
            trendControl.startTime = Date.now();
            trendControl.isTransitioning = true;
            trendControl.duration = 120;

            // 清除之前的定时器
            if (metricIntervalId !== null) {
                clearInterval(metricIntervalId);
            }
            if (trendIntervalId !== null) {
                clearInterval(trendIntervalId);
            }
            
            updateTrendLines();

            // 开始新的定时器
            metricIntervalId = setInterval(updateMetricValues, 1000);  // 每秒更新显示值
            trendIntervalId = setInterval(updateTrendData, 5000);     // 每5秒更新趋势图

            // 显示当前病人信息
            document.getElementById('initial-hr').textContent = patient.initial.hr;
            document.getElementById('initial-spo2').textContent = patient.initial.spo2;
            document.getElementById('initial-bp1').textContent = patient.initial.Pleth_bp1;
            document.getElementById('initial-bp2').textContent = patient.initial.Pleth_bp2;
            document.getElementById('initial-temp').textContent = patient.initial.temp;

            document.getElementById('target-hr').textContent = patient.target.hr;
            document.getElementById('target-spo2').textContent = patient.target.spo2;
            document.getElementById('target-bp1').textContent = patient.target.Pleth_bp1;
            document.getElementById('target-bp2').textContent = patient.target.Pleth_bp2;
            document.getElementById('target-temp').textContent = patient.target.temp;
            
            // 显示当前病人信息容器
            document.querySelector('.current-patient').style.display = 'block';
        }
    </script>
</body>
</html> 