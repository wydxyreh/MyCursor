<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>趋势图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            width: 1280px;
            height: 800px;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        .container {
            position: relative;
            margin: 32.3px 24.89px;
            width: 1230.23px;
            height: 735.88px;
        }

        /* 左侧数据面板样式 */
        .data-panel {
            position: absolute;
            width: 295.49px;
            height: 171.90px;
            background: #3F3F3F;
        }

        .data-panel.spo2 {
            left: 0;
            top: 0;
        }

        .data-panel.ecg {
            left: 0;
            top: 187.99px;
        }

        .data-panel.bp {
            left: 0;
            top: 375.99px;
            height: 300px;
        }

        .data-panel.temp {
            left: 0;
            top: 700px;
        }

        /* 数据面板内部布局 */
        .panel-content {
            padding: 12px 8px;
        }

        .metric-header {
            display: flex;
            gap: 25px;
            margin-bottom: 19px;
        }

        .metric-name {
            font-size: 16px;
            line-height: 19.78px;
        }

        .metric-value {
            font-size: 48px;
            line-height: 56px;
            margin-left: 40px;
        }

        .scale-container {
            display: flex;
            gap: 22px;
        }

        .scale-values {
            display: flex;
            flex-direction: column;
            gap: 23px;
        }

        .scale-value {
            font-size: 18px;
            line-height: 23px;
        }

        .trend-line {
            position: relative;
            width: 189.69px;
            height: 46.62px !important;
            overflow: visible !important;
        }

        /* 点和线的样式 */
        .trend-dot {
            position: absolute;
            width: 8.49px;
            height: 8.49px;
            background: #D9D9D9;
            border-radius: 50%;
        }

        .trend-segment {
            position: absolute;
            height: 1.39px;
            background: #fff;
            transform-origin: left center;
        }

        /* 添加CSS样式 */
        .baseline {
            position: absolute;
            width: 100%;
            height: 30%;
            opacity: 0.1;
        }
        .baseline.red {
            background: #FF5555;
        }
        .baseline.yellow {
            background: #FFD700;
        }
        .baseline.green {
            background: #00C764;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SpO2数据面板 -->
        <div class="data-panel spo2">
            <div class="panel-content">
                <div class="metric-header">
                    <div class="metric-name">SpO2</div>
                    <div class="metric-value">98</div>
                </div>
                <div class="scale-container">
                    <div class="scale-values">
                        <div class="scale-value">100</div>
                        <div class="scale-value">90</div>
                    </div>
                    <div class="trend-line" id="spo2-trend"></div>
                </div>
            </div>
        </div>

        <!-- ECG数据面板 -->
        <div class="data-panel ecg">
            <div class="panel-content">
                <div class="metric-header">
                    <div class="metric-name">ECG</div>
                    <div class="metric-value">72</div>
                </div>
                <div class="scale-container">
                    <div class="scale-values">
                        <div class="scale-value">120</div>
                        <div class="scale-value">60</div>
                    </div>
                    <div class="trend-line" id="ecg-trend"></div>
                </div>
            </div>
        </div>

        <!-- BP数据面板 -->
        <div class="data-panel bp">
            <div class="panel-content">
                <div class="metric-header">
                    <div class="metric-name">BP</div>
                    <div class="metric-value">35</div>
                </div>
                <div class="scale-container">
                    <div class="scale-values">
                        <div class="scale-value">140</div>
                        <div class="scale-value">90</div>
                    </div>
                    <div class="trend-line" id="bp-trend1"></div>
                </div>
                <div class="metric-value">80</div>
                <div class="scale-container">
                    <div class="scale-values">
                        <div class="scale-value">90</div>
                        <div class="scale-value">60</div>
                    </div>
                    <div class="trend-line" id="bp-trend2"></div>
                </div>

            </div>
        </div>

        <!-- TEMP数据面板 -->
        <div class="data-panel temp">
            <div class="panel-content">
                <div class="metric-header">
                    <div class="metric-name">TEMP</div>
                    <div class="metric-value">37.2</div>
                </div>
                <div class="scale-container">
                    <div class="scale-values">
                        <div class="scale-value">39</div>
                        <div class="scale-value">36</div>
                    </div>
                    <div class="trend-line" id="temp-trend"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function createTrendLine(containerId, points) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 修改metric判断逻辑
            let metric = containerId.split('-')[0];
            if (containerId.includes('bp-trend1')) {
                metric = 'bpv1';
            } else if (containerId.includes('bp-trend2')) {
                metric = 'bpv2';
            }
            
            // 添加基线
            switch(metric) {
                case 'spo2':
                    // SPO2: 85-90红色(5), 90-100绿色(10)
                    addBaseline(container, 'red', 0, 0.67);     // 85-90 (占比约67%)
                    addBaseline(container, 'green', 0.67, 1);   // 90-100 (占比约33%)
                    break;
                case 'ecg':
                    // ECG: 40-50红色(10), 50-60黄色(10), 60-100绿色(40), 100-120黄色(20), 120-140红色(20)
                    addBaseline(container, 'red', 0, 0.1);      // 40-50
                    addBaseline(container, 'yellow', 0.1, 0.2); // 50-60
                    addBaseline(container, 'green', 0.2, 0.6);  // 60-100
                    addBaseline(container, 'yellow', 0.6, 0.8); // 100-120
                    addBaseline(container, 'red', 0.8, 1);      // 120-140
                    break;
                case 'bpv1':  // 改为bpv1
                    // BP1: 80-90红色(10), 90-120绿色(30), 120-140黄色(20), 140-150红色(10)
                    addBaseline(container, 'red', 0, 0.14);    // 80-90
                    addBaseline(container, 'green', 0.14, 0.57);// 90-120
                    addBaseline(container, 'yellow', 0.57, 0.86);// 120-140
                    addBaseline(container, 'red', 0.86, 1);    // 140-150
                    break;
                case 'bpv2':  // 改为bpv2
                    // BP2: 50-60红色(10), 60-80绿色(20), 80-90黄色(10), 90-100红色(10)
                    addBaseline(container, 'red', 0, 0.2);     // 50-60
                    addBaseline(container, 'green', 0.2, 0.6); // 60-80
                    addBaseline(container, 'yellow', 0.6, 0.8);// 80-90
                    addBaseline(container, 'red', 0.8, 1);     // 90-100
                    break;
                case 'temp':
                    // TEMP: 35.5-36红色(0.5), 36-37.5绿色(1.5), 37.5-38.5红色(1)
                    addBaseline(container, 'red', 0, 0.17);    // 35.5-36
                    addBaseline(container, 'green', 0.17, 0.67);// 36-37.5
                    addBaseline(container, 'red', 0.67, 1);    // 37.5-38.5
                    break;
            }
            
            // 创建点和线
            points.forEach((point, index) => {
                const dot = document.createElement('div');
                dot.className = 'trend-dot';
                dot.style.left = `${point.x}px`;
                dot.style.top = `${point.y}px`;
                
                // 直接使用修正后的metric获取值
                const value = dataQueue[metric][index];
                
                switch(metric) {
                    case 'spo2':
                        // SPO2: <90红色, 90-100绿色
                        if (value < 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'ecg':
                        // ECG: <50红色, 50-60黄色, 60-100绿色, 100-120黄色, >120红色
                        if (value < 50 || value > 120) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 50 && value < 60) || (value >= 100 && value <= 120)) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'bpv1':
                        // BP1: <90红色, 90-120绿色, 120-140黄色, >140红色
                        if (value < 90 || value > 140) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if (value >= 120 && value <= 140) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'bpv2':
                        // BP2: <60红色, 60-80绿色, 80-90黄色, >90红色
                        if (value < 60 || value > 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if (value >= 80 && value <= 90) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'temp':
                        dot.style.background = (value < 36 || value > 38) ? '#FF5555' : '#00C764';
                        break;
                    default:
                        dot.style.background = '#D9D9D9';
                }
                
                container.appendChild(dot);

                // 创建连接线
                if (index < points.length - 1) {
                    const nextPoint = points[index + 1];
                    const segment = document.createElement('div');
                    segment.className = 'trend-segment';
                    
                    // 计算线段长度和角度
                    const length = Math.sqrt(
                        Math.pow(nextPoint.x - point.x, 2) + 
                        Math.pow(nextPoint.y - point.y, 2)
                    );
                    const angle = Math.atan2(
                        nextPoint.y - point.y,
                        nextPoint.x - point.x
                    ) * 180 / Math.PI;

                    segment.style.width = `${length}px`;
                    segment.style.transform = `rotate(${angle}deg)`;
                    segment.style.left = `${point.x}px`;
                    segment.style.top = `${point.y + dot.offsetHeight/2}px`;
                    
                    // 设置线段颜色与点的颜色相同
                    segment.style.background = dot.style.background;
                    
                    container.appendChild(segment);
                }
            });
        }

        // 添加基线的辅助函数
        function addBaseline(container, color, startPercent, endPercent) {
            const baseline = document.createElement('div');
            baseline.className = `baseline ${color}`;
            baseline.style.bottom = `${startPercent * 100}%`;
            baseline.style.height = `${(endPercent - startPercent) * 100}%`;
            container.appendChild(baseline);
        }

        // 存储过去5秒的数据队列
        const dataQueue = {
            spo2: [],
            ecg: [],
            bpv1: [],     // 改 etco2 为 bpv1
            bpv2: [],     // 改 etco2_2 为 bpv2
            temp: []
        };

        // 添加趋势控制系统
        const trendControl = {
            duration: 120,  // 2分钟 = 120秒
            startTime: null,
            initialValues: {
                spo2: 98,
                ecg: 80,
                bpv1: 120,
                bpv2: 70,
                temp: 36.5
            },
            targetValues: {
                spo2: 95,
                ecg: 100,
                bpv1: 130,
                bpv2: 85,
                temp: 37.2
            },
            isTransitioning: false
        };

        // 计算平滑过渡值的函数
        function calculateTransitionValue(initial, target, progress) {
            // 使用缓动函数使变化更自然
            progress = Math.sin(progress * Math.PI / 2);  // easeOut效果
            return initial + (target - initial) * progress;
        }

        // 修改生成随机数据的函数
        function generateRandomData() {
            if (!trendControl.isTransitioning) {
                return {
                    spo2: trendControl.initialValues.spo2,
                    ecg: trendControl.initialValues.ecg,
                    bpv1: trendControl.initialValues.bpv1,
                    bpv2: trendControl.initialValues.bpv2,
                    temp: trendControl.initialValues.temp
                };
            }

            const currentTime = Date.now();
            const progress = Math.min((currentTime - trendControl.startTime) / (trendControl.duration * 1000), 1);

            const result = {};
            Object.keys(trendControl.initialValues).forEach(metric => {
                const initial = trendControl.initialValues[metric];
                const target = trendControl.targetValues[metric];
                const baseValue = calculateTransitionValue(initial, target, progress);
                
                // 添加小幅度随机波动
                const fluctuation = metric === 'temp' ? 0.1 : 2;
                result[metric] = baseValue + (Math.random() - 0.5) * fluctuation;
                
                // 确保温度保留一位小数
                if (metric === 'temp') {
                    result[metric] = parseFloat(result[metric].toFixed(1));
                } else {
                    result[metric] = Math.floor(result[metric]);
                }
            });

            if (progress >= 1) {
                trendControl.isTransitioning = false;
            }

            return result;
        }

        // 更新数据面板显示值
        function updatePanelValues(data) {
            document.querySelector('.data-panel.spo2 .metric-value').textContent = data.spo2;
            document.querySelector('.data-panel.ecg .metric-value').textContent = data.ecg;
            // 更新BP面板的两个值
            const bpValues = document.querySelectorAll('.data-panel.bp .metric-value');  // 改 etco2 为 bp
            bpValues[0].textContent = data.bpv1;    // 改 etco2 为 bpv1
            bpValues[1].textContent = data.bpv2;    // 改 etco2_2 为 bpv2
            document.querySelector('.data-panel.temp .metric-value').textContent = data.temp;
        }

        // 更新趋势图
        function updateTrendLines() {
            const containerWidth = 189.69;
            const containerHeight = 23.31 * 2;
            
            Object.keys(dataQueue).forEach(metric => {
                let containerId = `${metric}-trend`;
                if (metric === 'bpv1') {
                    containerId = 'bp-trend1';
                } else if (metric === 'bpv2') {
                    containerId = 'bp-trend2';
                }
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                const points = dataQueue[metric].map((value, index) => {
                    const x = ((4 - (dataQueue[metric].length - 1 - index)) / 4) * containerWidth;
                    let y;
                    
                    switch(metric) {
                        case 'spo2':
                            // SPO2: 85-90红色(0-67%), 90-100绿色(67-100%)
                            if (value < 90) {
                                // 在红色区域内映射 (0-67%)
                                const redPosition = (value - 85) / (90 - 85);  // 0表示85，1表示90
                                y = containerHeight * (1 - redPosition * 0.67);
                            } else {
                                // 在绿色区域内映射 (67-100%)
                                const greenPosition = (value - 90) / (100 - 90);  // 0表示90，1表示100
                                y = containerHeight * (0.33 - greenPosition * 0.33);
                            }
                            break;
                        case 'ecg':
                            if (value <= 50) {
                                // 红色区域 (0-10%)
                                const position = (value - 40) / (50 - 40);
                                y = containerHeight * (1 - position * 0.1);
                            } else if (value <= 60) {
                                // 黄色区域 (10-20%)
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (0.9 - position * 0.1);
                            } else if (value <= 100) {
                                // 绿色区域 (20-60%)
                                const position = (value - 60) / (100 - 60);
                                y = containerHeight * (0.8 - position * 0.4);
                            } else if (value <= 120) {
                                // 黄色区域 (60-80%)
                                const position = (value - 100) / (120 - 100);
                                y = containerHeight * (0.4 - position * 0.2);
                            } else {
                                // 红色区域 (80-100%)
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (0.2 - position * 0.2);
                            }
                            break;
                        case 'bpv1':
                            if (value <= 90) {
                                // 红色区域 (0-14%)
                                const position = (value - 80) / (90 - 80);
                                y = containerHeight * (1 - position * 0.14);
                            } else if (value <= 120) {
                                // 绿色区域 (14-57%)
                                const position = (value - 90) / (120 - 90);
                                y = containerHeight * (0.86 - position * 0.43);
                            } else if (value <= 140) {
                                // 黄色区域 (57-86%)
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (0.43 - position * 0.29);
                            } else {
                                // 红色区域 (86-100%)
                                const position = (value - 140) / (150 - 140);
                                y = containerHeight * (0.14 - position * 0.14);
                            }
                            break;
                        case 'bpv2':
                            if (value <= 60) {
                                // 红色区域 (0-20%)
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (1 - position * 0.2);
                            } else if (value <= 80) {
                                // 绿色区域 (20-60%)
                                const position = (value - 60) / (80 - 60);
                                y = containerHeight * (0.8 - position * 0.4);
                            } else if (value <= 90) {
                                // 黄色区域 (60-80%)
                                const position = (value - 80) / (90 - 80);
                                y = containerHeight * (0.4 - position * 0.2);
                            } else {
                                // 红色区域 (80-100%)
                                const position = (value - 90) / (100 - 90);
                                y = containerHeight * (0.2 - position * 0.2);
                            }
                            break;
                        case 'temp':
                            if (value <= 36) {
                                // 红色区域 (0-17%)
                                const position = (value - 35.5) / (36 - 35.5);
                                y = containerHeight * (1 - position * 0.17);
                            } else if (value <= 37.5) {
                                // 绿色区域 (17-67%)
                                const position = (value - 36) / (37.5 - 36);
                                y = containerHeight * (0.83 - position * 0.5);
                            } else {
                                // 红色区域 (67-100%)
                                const position = (value - 37.5) / (38.5 - 37.5);
                                y = containerHeight * (0.33 - position * 0.33);
                            }
                            break;
                    }
                    
                    return {x, y: Math.max(0, Math.min(containerHeight, y))};
                });
                
                createTrendLine(containerId, points);
            });
        }

        // 分离数据更新和趋势图更新
        function updateMetricValues() {
            const newData = generateRandomData();
            // 只更新显示值
            updatePanelValues(newData);
        }

        function updateTrendData() {
            const newData = generateRandomData();
            // 更新数据队列和趋势图
            Object.keys(newData).forEach(metric => {
                dataQueue[metric].unshift(newData[metric]);
                if (dataQueue[metric].length > 5) {
                    dataQueue[metric].pop();
                }
            });
            
            // 更新趋势图
            updateTrendLines();
        }

        // 使用两个独立的定时器
        setInterval(updateMetricValues, 1000);  // 每秒更新显示值
        setInterval(updateTrendData, 5000);     // 每5秒更新趋势图

        // 初始化：填充初始数据
        for (let i = 0; i < 5; i++) {
            const initialData = generateRandomData();
            Object.keys(initialData).forEach(metric => {
                dataQueue[metric].unshift(initialData[metric]);
            });
        }
        updateTrendLines();

        function updateTrendPoints(metric, value, min, max) {
            const container = document.getElementById(`${metric}-trend`);
            if (!container) return;

            const point = document.createElement('div');
            point.className = 'trend-point';
            
            const range = max - min;
            const percentage = ((value - min) / range) * 100;
            point.style.bottom = `${percentage}%`;
            
            // 根据警报值设置颜色
            switch(metric) {
                case 'spo2':
                    point.style.backgroundColor = (value < 90) ? '#FF5555' : '#00C764';
                    break;
                case 'ecg':
                    point.style.backgroundColor = (value < 60 || value > 120) ? '#FF5555' : '#00C764';
                    break;
                case 'bpv1':               // 改 etco2 为 bpv1
                    point.style.backgroundColor = (value < 35 || value > 45) ? '#FF5555' : '#00C764';
                    break;
                case 'bpv2':               // 改 etco2_2 为 bpv2
                    point.style.backgroundColor = (value < 75 || value > 85) ? '#FF5555' : '#00C764';
                    break;
                case 'temp':
                    point.style.backgroundColor = (value < 36 || value > 39) ? '#FF5555' : '#00C764';
                    break;
            }
            
            container.appendChild(point);
            
            const points = container.getElementsByClassName('trend-point');
            if (points.length > 5) {
                container.removeChild(points[0]);
            }
        }

        // 更新CSS样式以适应新的高度
        const style = document.createElement('style');
        style.textContent = `
            .trend-line {
                position: relative;
                width: 189.69px;
                height: 46.62px !important;  // 双倍高度
                overflow: visible !important;  // 允许内容溢出
            }
        `;
        document.head.appendChild(style);

        // 添加录制相关的变量
        let mediaRecorder;
        let recordedChunks = [];
        
        // 修改startTransition函数，添加录制功能
        async function startTransition() {
            try {
                // 开始录制屏幕
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        displaySurface: "browser",
                        frameRate: 30
                    }
                });
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 5000000 // 5Mbps
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    // 创建视频文件并下载
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'trend_changes.webm';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // 停止所有轨道
                    stream.getTracks().forEach(track => track.stop());
                };

                // 开始录制
                mediaRecorder.start();
                
                // 开始趋势变化
                trendControl.startTime = Date.now();
                trendControl.isTransitioning = true;

                // 两分钟后自动停止录制
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                }, trendControl.duration * 1000);

            } catch (err) {
                console.error("录制出错:", err);
                // 如果录制失败，仍然开始趋势变化
                trendControl.startTime = Date.now();
                trendControl.isTransitioning = true;
            }
        }

        // 添加一个停止录制的函数
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        // 修改控制面板HTML，添加录制状态指示
        const controlPanel = document.createElement('div');
        controlPanel.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background: #3F3F3F; padding: 20px; border-radius: 5px;">
                <h3 style="color: white; margin-top: 0;">趋势控制</h3>
                <div id="valueInputs"></div>
                <button onclick="startTransition()" style="margin-top: 10px; padding: 5px 10px;">开始变化并录制</button>
                <div id="recordingStatus" style="color: white; margin-top: 10px; display: none;">
                    正在录制...
                </div>
            </div>
        `;
        document.body.appendChild(controlPanel);

        // 创建输入字段
        const valueInputs = document.getElementById('valueInputs');
        Object.keys(trendControl.initialValues).forEach(metric => {
            const container = document.createElement('div');
            container.style.marginBottom = '10px';
            container.innerHTML = `
                <div style="color: white; margin-bottom: 5px;">${metric.toUpperCase()}</div>
                <div style="display: flex; gap: 10px;">
                    <input type="number" step="${metric === 'temp' ? '0.1' : '1'}" 
                           value="${trendControl.initialValues[metric]}"
                           onchange="updateValue('${metric}', 'initial', this.value)"
                           style="width: 60px;">
                    →
                    <input type="number" step="${metric === 'temp' ? '0.1' : '1'}" 
                           value="${trendControl.targetValues[metric]}"
                           onchange="updateValue('${metric}', 'target', this.value)"
                           style="width: 60px;">
                </div>
            `;
            valueInputs.appendChild(container);
        });

        // 更新值的函数
        function updateValue(metric, type, value) {
            value = parseFloat(value);
            if (type === 'initial') {
                trendControl.initialValues[metric] = value;
            } else {
                trendControl.targetValues[metric] = value;
            }
        }
    </script>
</body>
</html> 