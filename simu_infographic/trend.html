<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>趋势图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            width: 1280px;
            height: 800px;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        .container {
            position: relative;
            margin: 24px 24px;
            width: 1200px;
            height: 800px;
        }

        /* 左侧数据面板样式 */
        .data-panel {
            position: absolute;
            width: 300px;
            height: 200px;
            background: #3F3F3F;
            left: 0;
        }

        .data-panel.spo2 {
            top: 0;
        }

        .data-panel.hr {
            top: 210px;
        }

        .data-panel.bp {
            top: 420px;
            height: 300px;
        }

        .data-panel.temp {
            top: 730px;
        }

        /* 数据面板内部布局 */
        .panel-content {
            padding: 5px 10px;
        }

        .metric-header {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
        }

        .metric-name {
            font-size: 16px;
            line-height: 20px;
        }

        .metric-container {
            display: grid; /* 父容器设置为 Grid 容器 */
            grid-template-columns: repeat(3, auto); /* 改为三列以适应分隔符 */
            justify-items: center; /* 让子元素内容居中 */
            align-items: center; /* 让子元素内容垂直居中 */
            gap: 0px; /* 设置元素之间的间隔距离 */
        }

        .metric-separator { 
            /* 用于分隔符的样式 */
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
        }

        .metric-value-BP {
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
        }

        .metric-value {
            position: relative; /* 添加此行，使 top 生效 */
            top: -30px; /* 现在 top 会生效 */
            font-size: 60px;
            text-align: center;
            width: 100%;
            display: flex; /* 使用 Flexbox 实现垂直居中 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
        }

        .scale-container {
            position: relative;
            top: -30px;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .scale-values {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* 这行将所有子元素右对齐 */
        }

        .scale-value {
            font-size: 12px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .scale-value-spo2-1 {
            top: -5px;
        }
        
        .scale-value-spo2-2 {
            top: -5px;
        }

        .scale-value-spo2-3 {
            top: 65px;
        }

        .scale-value-hr-1 {
            top: -5px;
        }

        .scale-value-hr-2 {
            top: -5px;
        }

        .scale-value-hr-3 {
            top: -5px;
        }
        
        .scale-value-hr-4 {
            top: 5px;
        }
        
        .scale-value-hr-5 {
            top: 5px;
        }
        
        .scale-value-hr-6 {
            top: 20px;
        }

        .scale-value-bp1-1 {
            top: -5px;
        }

        .scale-value-bp1-2 {
            top: 10px;
        }

        .scale-value-bp1-3 {
            top: 10px;
        }
        
        .scale-value-bp1-4 {
            top: 20px;
        }
        
        .scale-value-bp1-5 {
            top: 35px;
        }

        .scale-value-bp2-1 {
            top: -5px;
        }

        .scale-value-bp2-2 {
            top: 30px;
        }

        .scale-value-bp2-3 {
            top: 30px;
        }
        
        .scale-value-bp2-4 {
            top: 35px;
        }
        
        .scale-value-bp2-5 {
            top: 35px;
        }

        .scale-value-temp-1 {
            top: -5px;
        }

        .scale-value-temp-2 {
            top: 5px;
        }

        .scale-value-temp-3 {
            top: 45px;
        }
        
        .scale-value-temp-4 {
            top: 50px;
        }

        .trend-line {
            position: relative;
            width: 300px;
            height: 100px;
            overflow: visible;
        }

        /* 点和线的样式 */
        .trend-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #D9D9D9;
            border-radius: 50%;
        }

        .trend-segment {
            position: absolute;
            height: 1.5px;
            background: #fff;
            transform-origin: left center;
        }

        /* 添加CSS样式 */
        .baseline {
            position: absolute;
            width: 100%;
            height: 30%;
            opacity: 0.1;
        }
        .baseline.red {
            background: #FF5555;
        }
        .baseline.yellow {
            background: #FFD700;
        }
        .baseline.green {
            background: #00C764;
        }

        .line-divider {
            position: absolute;
            left: 30px;
            top: 189px;
            height: 1px;
            background-color: white;
            width: 90%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SpO2数据面板 -->
        <div class="data-panel spo2">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">SpO2</div>
                </div>

                <div class="metric-value">98</div>
                
                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-spo2-1">100</div>
                        <div class="scale-value scale-value-spo2-2">90</div>
                        <div class="scale-value scale-value-spo2-3">0</div>
                    </div>

                    <div class="trend-line" id="spo2-trend"></div>
                </div>
            </div>
        </div>

        <!-- HR数据面板 -->
        <div class="data-panel hr">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">HR</div>
                </div>

                <div class="metric-value">72</div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-hr-1">140</div>
                        <div class="scale-value scale-value-hr-2">120</div>
                        <div class="scale-value scale-value-hr-3">100</div>
                        <div class="scale-value scale-value-hr-4">60</div>
                        <div class="scale-value scale-value-hr-5">50</div>
                        <div class="scale-value scale-value-hr-6">0</div>
                    </div>

                    <div class="trend-line" id="hr-trend"></div>
                </div>
            </div>
        </div>

        <!-- BP数据面板 -->
        <div class="data-panel bp">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">BP</div>
                </div>
                
                <div class="metric-container">
                    <div class="metric-value-BP">35</div>
                    <div class="metric-separator">/</div>
                    <div class="metric-value-BP">80</div>
                </div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-bp1-1">180</div>
                        <div class="scale-value scale-value-bp1-2">140</div>
                        <div class="scale-value scale-value-bp1-3">120</div>
                        <div class="scale-value scale-value-bp1-4">90</div>
                        <div class="scale-value scale-value-bp1-5">50</div>
                    </div>
                   
                    <div class="trend-line" id="bp-trend1"></div>
                </div>

                <!-- 分割线 -->
                <div class="line-divider"></div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-bp2-1">130</div>
                        <div class="scale-value scale-value-bp2-2">90</div>
                        <div class="scale-value scale-value-bp2-3">80</div>
                        <div class="scale-value scale-value-bp2-4">60</div>
                        <div class="scale-value scale-value-bp2-5">50</div>
                    </div>

                    <div class="trend-line" id="bp-trend2"></div>
                </div>

            </div>
        </div>

        <!-- TEMP数据面板 -->
        <div class="data-panel temp">
            <div class="panel-content">

                <div class="metric-header">
                    <div class="metric-name">TEMP</div>
                </div>

                <div class="metric-value">37.2</div>

                <div class="scale-container">

                    <div class="scale-values">
                        <div class="scale-value scale-value-temp-1">38.0</div>
                        <div class="scale-value scale-value-temp-2">37.3</div>
                        <div class="scale-value scale-value-temp-3">36.0</div>
                        <div class="scale-value scale-value-temp-4">35.5</div>
                    </div>

                    <div class="trend-line" id="temp-trend"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function createTrendLine(containerId, points) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 修改metric判断逻辑
            let metric = containerId.split('-')[0];
            if (containerId.includes('bp-trend1')) {
                metric = 'bpv1';
            } else if (containerId.includes('bp-trend2')) {
                metric = 'bpv2';
            }

            // 添加基线
            switch(metric) {
                case 'spo2':
                    // SPO2: 85-90红色(5), 90-100绿色(10)
                    addBaseline(container, 'red', 0/100, 90/100);     // 0-90
                    addBaseline(container, 'green', 90/100, 100/100);   // 90-100
                    break;
                case 'hr':
                    // HR: 0-50红色(50/140), 50-60黄色(10/140), 60-100绿色(40/140), 100-120黄色(20/140), 120-140红色(20/140)
                    addBaseline(container, 'red', 0/140, 50/140);      // 0-50
                    addBaseline(container, 'yellow', 50/140, 60/140); // 50-60
                    addBaseline(container, 'green', 60/140, 100/140);  // 60-100
                    addBaseline(container, 'yellow', 100/140, 120/140); // 100-120
                    addBaseline(container, 'red', 120/140, 140/140);      // 120-140
                    break;
                case 'bpv1':
                    // BP1: 50-90红色, 90-120绿色, 120-140黄色, 140-180红色
                    addBaseline(container, 'red', (50 - 50) / (180 - 50) , (90 - 50) / (180 - 50));    // 50-90
                    addBaseline(container, 'green', (90 - 50) / (180 - 50) , (120 - 50) / (180 - 50));    // 90-120
                    addBaseline(container, 'yellow', (120 - 50) / (180 - 50) , (140 - 50) / (180 - 50));    // 120-140
                    addBaseline(container, 'red', (140 - 50) / (180 - 50) , (180 - 50) / (180 - 50));    // 140-180
                    break;
                case 'bpv2':
                    // BP2: 50-60红色, 60-80绿色, 80-90黄色, 90-130红色
                    addBaseline(container, 'red', (50 - 50) / (130 - 50) , (60 - 50) / (130 - 50));    // 50-60
                    addBaseline(container, 'green', (60 - 50) / (130 - 50) , (80 - 50) / (130 - 50));    // 60-80
                    addBaseline(container, 'yellow', (80 - 50) / (130 - 50) , (90 - 50) / (130 - 50));    // 80-90
                    addBaseline(container, 'red', (90 - 50) / (130 - 50) , (130 - 50) / (130 - 50));    // 90-130
                    break;
                case 'temp':
                    // TEMP: 35.5-36红色(0.5), 36-37.5绿色(1.5), 37.5-38.5红色(1)
                    addBaseline(container, 'red', (35.5 - 35.5) / (38 - 35.5) , (36 - 35.5) / (38 - 35.5));    // 35.5-36
                    addBaseline(container, 'green', (36 - 35.5) / (38 - 35.5) , (37.3 - 35.5) / (38 - 35.5));    // 36-37.5
                    addBaseline(container, 'red', (37.3 - 35.5) / (38 - 35.5) , (38 - 35.5) / (38 - 35.5));    // 37.5-38.5
                    break;
            }

            // 创建点和线
            points.forEach((point, index) => {
                const dot = document.createElement('div');
                dot.className = 'trend-dot';
                dot.style.left = `${point.x}px`;
                dot.style.top = `${point.y - 3}px`;
                
                // 直接使用修正后的metric获取值
                const value = dataQueue[metric][index];
                
                switch(metric) {
                    case 'spo2':
                        // SPO2: <90红色, 90-100绿色
                        if (value < 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'hr':
                        // HR: <50红色, 50-60黄色, 60-100绿色, 100-120黄色, >120红色
                        if (value < 50 || value > 120) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if ((value >= 50 && value < 60) || (value >= 100 && value <= 120)) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'bpv1':
                        // BP1: 50-90红色, 90-120绿色, 120-140黄色, 140-180红色
                        if (value < 90 || value > 140) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if (value >= 120 && value <= 140) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'bpv2':
                        // BP2: 50-60红色, 60-80绿色, 80-90黄色, 90-130红色
                        if (value < 60 || value > 90) {
                            dot.style.background = '#FF5555';  // 红色
                        } else if (value >= 80 && value <= 90) {
                            dot.style.background = '#FFD700';  // 黄色
                        } else {
                            dot.style.background = '#00C764';  // 绿色
                        }
                        break;
                    case 'temp':
                        dot.style.background = (value < 36 || value > 37.3) ? '#FF5555' : '#00C764';
                        break;
                    default:
                        dot.style.background = '#D9D9D9';
                }
                
                container.appendChild(dot);

                // 创建连接线
                if (index < points.length - 1) {
                    const nextPoint = points[index + 1];
                    const segment = document.createElement('div');
                    segment.className = 'trend-segment';
                    
                    // 计算线段长度和角度
                    const length = Math.sqrt(
                        Math.pow(nextPoint.x - point.x, 2) + 
                        Math.pow(nextPoint.y - point.y, 2)
                    );
                    const angle = Math.atan2(
                        nextPoint.y - point.y,
                        nextPoint.x - point.x
                    ) * 180 / Math.PI;

                    segment.style.width = `${length}px`;
                    segment.style.transform = `rotate(${angle}deg)`;
                    segment.style.left = `${point.x}px`;
                    segment.style.top = `${point.y + dot.offsetHeight / 2 - 3}px`;
                    
                    // 设置线段颜色与点的颜色相同
                    segment.style.background = dot.style.background;
                    
                    container.appendChild(segment);
                }
            });
        }

        // 添加基线的辅助函数
        function addBaseline(container, color, startPercent, endPercent) {
            const baseline = document.createElement('div');
            baseline.className = `baseline ${color}`;
            baseline.style.bottom = `${startPercent * 100}%`;
            baseline.style.height = `${(endPercent - startPercent) * 100}%`;
            container.appendChild(baseline);
        }

        // 存储过去25秒的数据队列
        const dataQueue = {
            spo2: [],
            hr: [],
            bpv1: [],
            bpv2: [],
            temp: []
        };

        // 存储 5 秒的平均值
        const dataArray = {
            spo2: [],
            hr: [],
            bpv1: [],
            bpv2: [],
            temp: []
        };

        // 添加趋势控制系统
        const trendControl = {
            duration: 120,  // 2分钟 = 120秒
            startTime: null,
            initialValues: {
                spo2: 80,
                hr: 40,
                bpv1: 70,
                bpv2: 50,
                temp: 35.5
            },
            targetValues: {
                spo2: 90,
                hr: 130,
                bpv1: 160,
                bpv2: 100,
                temp: 38.0
            },
            isTransitioning: false
        };

        // 计算平滑过渡值的函数
        function calculateTransitionValue(initial, target, progress) {
            // 使用缓动函数使变化更自然
            progress = Math.sin(progress * Math.PI / 2);
            return initial + (target - initial) * progress;
        }

        // 生成随机数据的函数
        function generateRandomData() {
            if (!trendControl.isTransitioning) {
            return {
                    spo2: trendControl.initialValues.spo2,
                    hr: trendControl.initialValues.hr,
                    bpv1: trendControl.initialValues.bpv1,
                    bpv2: trendControl.initialValues.bpv2,
                    temp: trendControl.initialValues.temp
                };
            }

            const currentTime = Date.now();
            const progress = Math.min((currentTime - trendControl.startTime) / (trendControl.duration * 1000), 1);

            const result = {};
            Object.keys(trendControl.initialValues).forEach(metric => {
                const initial = trendControl.initialValues[metric];
                const target = trendControl.targetValues[metric];
                const baseValue = calculateTransitionValue(initial, target, progress);

                // 根据当前值和目标值之间的差值来决定波动范围
                let fluctuation;
                if (progress < 1) { // 如果还未完成过渡
                    fluctuation = Math.abs(baseValue - target) * 0.1; // 波动范围为差值的10%
                } else {
                    fluctuation = 0; // 最后一次更新直接设置为目标值
                }

                // 计算新值
                let newValue = baseValue + (Math.random() * 2 - 1) * fluctuation; // 随机增加或减少
                
                // 确保温度保留一位小数，其他指标取整
                if (metric === 'temp') {
                    result[metric] = parseFloat(newValue.toFixed(1));
                } else {
                    result[metric] = Math.floor(newValue);
                }
                
                // 当过渡结束时，确保值为目标值
                if (progress >= 1) {
                    result[metric] = target;
                }
            });

            if (progress >= 1) {
                trendControl.isTransitioning = false;
            }

            return result;
        }

        // 更新数据面板显示值
        function updatePanelValues(data) {
            document.querySelector('.data-panel.spo2 .metric-value').textContent = data.spo2;
            document.querySelector('.data-panel.hr .metric-value').textContent = data.hr;
            // 更新BP面板的两个值
            const bpValues = document.querySelectorAll('.data-panel.bp .metric-value-BP');
            bpValues[0].textContent = data.bpv1;
            bpValues[1].textContent = data.bpv2;
            document.querySelector('.data-panel.temp .metric-value').textContent = data.temp;
        }

        // 更新趋势图
        function updateTrendLines() {
            const containerWidth = 300;
            let containerHeight = 100;
            
            Object.keys(dataQueue).forEach(metric => {
                let containerId = `${metric}-trend`;
                if (metric === 'bpv1') {
                    containerId = 'bp-trend1';
                } else if (metric === 'bpv2') {
                    containerId = 'bp-trend2';
                }
                
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                const points = dataQueue[metric].map((value, index) => {
                    const x = (index / 5) * 240;
                    let y;
                    
                    switch(metric) {
                        case 'spo2':
                            const spo2_totalRange = 100; // 总范围是0到100

                            if (value < 90) { // 红色区域 (0-90)
                                // 计算在0到90之间的比例位置
                                const position = value / 90;
                                y = containerHeight * (1 - (position * (90 / spo2_totalRange))); // 映射到0到90/100之间
                            } else { // 绿色区域 (90-100)
                                // 计算在90到100之间的比例位置
                                const position = (value - 90) / (100 - 90);
                                y = containerHeight * (1 - ((position * (10 / spo2_totalRange)) + (90 / spo2_totalRange))); // 映射到90/100到100/100之间
                            }
                            break;
                        case 'hr':
                            const hr_totalRange = 140; // 总范围

                            if (value <= 50) { // 红色区域 (0-50)
                                // 计算在0到50之间的比例位置
                                const position = value / 50;
                                y = containerHeight * (1 - (position * (50 / hr_totalRange))); // 落在0到50/140之间
                            } else if (value <= 60) { // 黄色区域 (50-60)
                                // 计算在50到60之间的比例位置
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (1 - ((position * (10 / hr_totalRange)) + (50 / hr_totalRange))); // 落在50/140到60/140之间
                            } else if (value <= 100) { // 绿色区域 (60-100)
                                // 计算在60到100之间的比例位置
                                const position = (value - 60) / (100 - 60);
                                y = containerHeight * (1 - ((position * (40 / hr_totalRange)) + (60 / hr_totalRange))); // 落在60/140到100/140之间
                            } else if (value <= 120) { // 黄色区域 (100-120)
                                // 计算在100到120之间的比例位置
                                const position = (value - 100) / (120 - 100);
                                y = containerHeight * (1 - ((position * (20 / hr_totalRange)) + (100 / hr_totalRange))); // 落在100/140到120/140之间
                            } else { // 红色区域 (120-140)
                                // 计算在120到140之间的比例位置
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (1 - ((position * (20 / hr_totalRange)) + (120 / hr_totalRange))); // 落在120/140到140/140之间
                            }
                            break;
                        case 'bpv1':
                            const bpv1_totalRange = 180 - 50; // 总范围是从50到180

                            if (value <= 90) { // 红色区域 (50-90)
                                // 计算在50到90之间的比例位置
                                const position = (value - 50) / (90 - 50);
                                y = containerHeight * (1 - position * ((90 - 50) / bpv1_totalRange)); // 映射到从顶部到底部的比例
                            } else if (value <= 120) { // 绿色区域 (90-120)
                                // 计算在90到120之间的比例位置
                                const position = (value - 90) / (120 - 90);
                                y = containerHeight * (1 - (((position * (120 - 90) / bpv1_totalRange)) + ((90 - 50) / bpv1_totalRange))); // 加上前一段的比例
                            } else if (value <= 140) { // 黄色区域 (120-140)
                                // 计算在120到140之间的比例位置
                                const position = (value - 120) / (140 - 120);
                                y = containerHeight * (1 - (((position * (140 - 120) / bpv1_totalRange)) + ((120 - 50) / bpv1_totalRange))); // 加上前两段的比例
                            } else { // 红色区域 (140-180)
                                // 计算在140到180之间的比例位置
                                const position = (value - 140) / (180 - 140);
                                y = containerHeight * (1 - (((position * (180 - 140) / bpv1_totalRange)) + ((140 - 50) / bpv1_totalRange))); // 加上前三段的比例
                            }
                            break;
                        case 'bpv2':
                            const bpv2_totalRange = 130 - 50; // 总范围是从50到130

                            if (value <= 60) { // 第一个区间 (50-60)
                                // 计算在50到60之间的比例位置
                                const position = (value - 50) / (60 - 50);
                                y = containerHeight * (1 - position * ((60 - 50) / bpv2_totalRange)); // 映射到从顶部到底部的比例
                            } else if (value <= 80) { // 第二个区间 (60-80)
                                // 计算在60到80之间的比例位置
                                const position = (value - 60) / (80 - 60);
                                y = containerHeight * (1 - (((position * (80 - 60) / bpv2_totalRange)) + ((60 - 50) / bpv2_totalRange))); // 加上前一段的比例
                            } else if (value <= 90) { // 第三个区间 (80-90)
                                // 计算在80到90之间的比例位置
                                const position = (value - 80) / (90 - 80);
                                y = containerHeight * (1 - (((position * (90 - 80) / bpv2_totalRange)) + ((80 - 50) / bpv2_totalRange))); // 加上前两段的比例
                            } else { // 第四个区间 (90-130)
                                // 计算在90到130之间的比例位置
                                const position = (value - 90) / (130 - 90);
                                y = containerHeight * (1 - (((position * (130 - 90) / bpv2_totalRange)) + ((90 - 50) / bpv2_totalRange))); // 加上前三段的比例
                            }
                            break;
                        case 'temp':
                            const temp_totalRange = 38 - 35.5; // 总范围

                            if (value <= 36) {
                                // 计算在35.5到36之间的比例位置
                                const position = (value - 35.5) / (36 - 35.5);
                                y = containerHeight * (1 - ((position * 0.5) / temp_totalRange)); // 0.5 是从35.5到36的占比
                            } else if (value <= 37.3) {
                                // 计算在36到37.3之间的比例位置
                                const position = (value - 36) / (37.3 - 36); // 从36开始计算位置
                                y = containerHeight * (1 - (((position * 1.3) / temp_totalRange) + (0.5 / temp_totalRange))); // 1.3是从36到37.3的占比，加上之前的0.5
                            } else {
                                // 计算在37.3到38之间的比例位置
                                const position = (value - 37.3) / (38 - 37.3);
                                y = containerHeight * (1 - (((position * 0.7) / temp_totalRange) + ((0.5 + 1.3) / temp_totalRange))); // 0.7是从37.3到38的占比，加上前面的0.5和1.3
                            }
                            break;
                    }
                    
                    return {x, y: Math.max(0, Math.min(containerHeight, y))};
                });
                
                createTrendLine(containerId, points);
            });
        }

        function calculateAverage(dataArray) {
            const sum = dataArray.reduce((acc, curr) => acc + curr, 0);
            return sum / dataArray.length;
        }
        
        // 更新显示数据
        function updateMetricValues() {
            const newData = generateRandomData();
            // 将新数据添加到 dataArray 中对应指标的数组尾部
            Object.keys(newData).forEach(metric => {
                if (dataArray[metric].length > 5) dataArray[metric].shift(); // 当数据量超过5时，移除最早的数据
                dataArray[metric].push(newData[metric]); // 新数据添加到尾部
            });
            // 只更新显示值
            updatePanelValues(newData);
        }

        // 更新趋势数据
        function updateTrendData() {
            const avgData = {};
            // 对于每个度量，计算其最近5次数据的平均值
            Object.keys(dataArray).forEach(metric => {
                avgData[metric] = calculateAverage(dataArray[metric]);
                // 清空该指标的队列，为下次计算准备
                dataArray[metric] = [];
            });

            let newData = avgData;
            // 更新数据队列和趋势图
            Object.keys(newData).forEach(metric => {
                if (dataQueue[metric].length > 5) dataQueue[metric].shift(); // 当数据量超过5时，移除最早的数据
                dataQueue[metric].push(newData[metric]); // 新数据添加到尾部
            });
            
            // 更新趋势图
            updateTrendLines();
        }

        updateTrendLines();

        // 添加录制相关的变量
        let mediaRecorder;
        let recordedChunks = [];
        
        // 添加录制功能
        async function startTransition() {
            try {
                // 开始录制屏幕
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        displaySurface: "browser",
                        frameRate: 30
                    }
                });
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 5000000 // 5Mbps
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    // 创建视频文件并下载
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'trend_changes.webm';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // 停止所有轨道
                    stream.getTracks().forEach(track => track.stop());
                };

                // 开始录制
                mediaRecorder.start();
                
                // 添加3秒延迟
                setTimeout(function() {
                    // 开始趋势变化
                    trendControl.startTime = Date.now();
                    trendControl.isTransitioning = true;
                    setInterval(updateMetricValues, 1000);  // 每秒更新显示值
                    setInterval(updateTrendData, 5000);     // 每5秒更新趋势图
                }, 1000);

                // 两分钟后自动停止录制
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                }, trendControl.duration * 1000);

            } catch (err) {
                console.error("录制出错:", err);
                // 如果录制失败，仍然开始趋势变化
                trendControl.startTime = Date.now();
                trendControl.isTransitioning = true;
            }
        }

        // 添加一个停止录制的函数
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        // 修改控制面板HTML，添加录制状态指示
        const controlPanel = document.createElement('div');
        controlPanel.innerHTML = `
            <div style="position: fixed; top: 20px; right: 20px; background: #3F3F3F; padding: 20px; border-radius: 5px;">
                <h3 style="color: white; margin-top: 0;">趋势控制</h3>
                <div id="valueInputs"></div>
                <button onclick="startTransition()" style="margin-top: 10px; padding: 5px 10px;">开始变化并录制</button>
                <div id="recordingStatus" style="color: white; margin-top: 10px; display: none;">
                    正在录制...
                </div>
            </div>
        `;
        document.body.appendChild(controlPanel);

        // 创建输入字段
        const valueInputs = document.getElementById('valueInputs');
        Object.keys(trendControl.initialValues).forEach(metric => {
            const container = document.createElement('div');
            container.style.marginBottom = '10px';
            container.innerHTML = `
                <div style="color: white; margin-bottom: 5px;">${metric.toUpperCase()}</div>
                <div style="display: flex; gap: 10px;">
                    <input type="number" step="${metric === 'temp' ? '0.1' : '10'}" 
                           value="${trendControl.initialValues[metric]}"
                           onchange="updateValue('${metric}', 'initial', this.value)"
                           style="width: 60px;">
                    →
                    <input type="number" step="${metric === 'temp' ? '0.1' : '10'}" 
                           value="${trendControl.targetValues[metric]}"
                           onchange="updateValue('${metric}', 'target', this.value)"
                           style="width: 60px;">
                </div>
            `;
            valueInputs.appendChild(container);
        });

        // 更新值的函数
        function updateValue(metric, type, value) {
            value = parseFloat(value);
            if (type === 'initial') {
                trendControl.initialValues[metric] = value;
            } else {
                trendControl.targetValues[metric] = value;
            }
        }
    </script>
</body>
</html> 