<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>治疗模拟</title>
    <style>
        /* 基础样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
            color: #fff;
            margin: 0;
            padding: 1%;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px;
        }

        .top-section {
            display: flex;
            gap: 100px;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100px; /* 小长方形的宽度 */
        }

        .middle-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .top-blank-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .right-section .blank-rectangle {
            width: 630px; /* 300+300+30间隙 */
            height: 100px;
            background-color: #333;
        }


        .small-rectangle {
            width: 190px; /* 小长方形的宽度 */
            height: 100px;
            background-color: #333;
        }

        .cpr-defibrillation {
            background-color: #808080; /* 灰色背景 */
            position: relative; /* 使该div相对于正常文档流定位 */
            z-index: 10; /* 确保它覆盖在其他元素之上 */
            padding: 10px; /* 可选：根据需要调整内边距 */
            display: flex;
            gap: 10px;
            top: -35px;
        }

        /* CPR模块 */
        .monitor-container {
            width: 300px;
            height: 225px;
            background-color: #4d4b4b;
            position: relative;
            overflow: hidden;
        }

        .monitor-content {
            width: 300px;
            height: 225px;
            position: absolute;
            top: 3px;
            left: 6px;
        }

        .title {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            color: #fff;
            text-align: center;
            font-size: 24px;
            height: 30px;
            line-height: 30px;
        }

        .progress-bar {
            position: absolute;
            top: 36px;
            left: 15px;
            width: 270px;
            height: 22.5px;
            background: #323232;
            overflow: hidden;
        }

        .progress {
            width: 100%;
            height: 24px;
            background: #E4E4E4;
            transition: width 1s linear;
        }

        .ratio {
            position: absolute;
            right: 3px;
            top: 1.5px;
            color: #fff;
            font-size: 15px;
            z-index: 1;
        }

        .metrics {
            position: absolute;
            top: 60px;
            left: 37.5px;
            width: calc(100% - 30px);
            height: 27px;
            display: flex;
            justify-content: flex-start;
            gap: 33px;
            color: #fff;
            font-size: 15px;
        }

        .metric {
            display: flex;
            gap: 6px;
            white-space: nowrap;
            align-items: center;
        }

        .metric span {
            white-space: nowrap;
        }

        .metric-value {
            min-width: max-content;
        }

        .chart-container {
            position: absolute;
            top: 96px;
            left: 0;
            width: 100%;
            height: 82.5px;
        }

        .chart {
            position: absolute;
            top: 0;
            left: 30px;
            right: 30px;
            height: 75px;
            display: flex;
            gap: 9px;
        }

        .bar {
            width: 12px;
            transition: height 0.3s ease;
        }

        .bar.success {
            background: #00C764;
        }

        .bar.warning {
            background: #FFCD05;
        }

        .bar.danger {
            background: #FF5757;
        }

        .scale-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1.5px;
            background: none;
            border-top: 0.5px dashed #fff;
        }

        .scale-line-1 {
            top: 75px;
        }

        .scale-line-2 {
            top: 90px;
        }

        .scale-value {
            position: absolute;
            left: 0;
            color: #fff;
            font-size: 15px;
        }

        .scale-value-1 {
            top: 60px;
        }

        .scale-value-2 {
            top: 90px;
        }

        .warnings {
            position: absolute;
            bottom: -3px;
            left: 45px;
            right: 30px;
            height: 30px;
            display: flex;
            gap: 4.5px;
            color: #fff;
            font-size: 15px;
        }
        
        /* 除颤模块 */
        .defibrillation-module {
            background-color: #4d4b4b;
            padding: 15px;
            border-radius: 0;
            width: 300px;
            height: 225px;
            position: relative;
        }

        .defibrillation-title {
            font-size: 20px;
            text-align: center;
            margin-bottom: 10px;
        }

        .status {
            font-size: 16px;
            text-align: center;
            margin: 10px 0;
        }

        .metrics-row {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }

        .energy-display {
            font-size: 48px;
            text-align: center;
            margin: 15px 0;
        }

        .energy-unit {
            font-size: 24px;
            margin-left: 5px;
        }

        .warning-message {
            color: #FF3B30;
            font-size: 16px;
            text-align: center;
            margin-top: 10px;
        }

        .waiting-message {
            color: #00C764;
            font-size: 16px;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-section">
            <!-- 左边的小方块 -->
            <div class="left-section">
                <div class="small-rectangle"></div>
                <div class="small-rectangle"></div>
                <div class="small-rectangle"></div>
                <div class="small-rectangle"></div>
            </div>

            <!-- 右边的CPR和除颤模块 -->
            <div class="right-section">
                <div class="top-blank-container">
                    <div class="blank-rectangle"></div>
                    <div class="blank-rectangle"></div>
                </div>

                <div class="cpr-defibrillation">
                    <div class="monitor-container">
                        <div class="monitor-content">
                            <h1 class="title">CPR</h1>

                            <div class="progress-bar">
                                <div class="progress"></div>
                                <span class="ratio">1:20</span>
                            </div>

                            <div class="metrics">
                                <div class="metric">
                                    <span>深度</span>
                                    <span class="metric-value">5.5/cm</span>
                                </div>
                                <div class="metric">
                                    <span>频率</span>
                                    <span class="metric-value">100/min</span>
                                </div>
                            </div>

                            <div class="chart-container">
                                <div class="chart"></div>
                                <div class="scale-line scale-line-1"></div>
                                <div class="scale-line scale-line-2"></div>
                                <span class="scale-value scale-value-1">5.0</span>
                                <span class="scale-value scale-value-2">6.0</span>
                            </div>

                            <div class="warnings">
                                <span>按压过深！</span>
                                <span>按压过快！</span>
                            </div>
                        </div>
                    </div>

                    <!-- 除颤模块 -->
                    <div class="defibrillation-module">
                        <div class="defibrillation-title">除颤</div>
                        <div class="status">等待中...</div>
                        <div class="metrics-row">
                            <div class="metric">
                                <span>电击</span>
                                <span class="shock-count">0次</span>
                            </div>
                            <div class="metric">
                                <span>能量</span>
                                <span class="energy-value">0J</span>
                            </div>
                        </div>
                        <div class="energy-display">
                            <span class="energy-display-value">0</span><span class="energy-unit">J</span>
                        </div>
                        <div class="waiting-message">等待除颤信号</div>
                        <div class="warning-message" style="display: none;">检测到可除颤信号！</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript部分
        class CPRMonitor {
            constructor() {
                this.chart = document.querySelector('.chart');
                this.maxBars = 12;
                this.pressData = [];
                this.updateInterval = 1000;
                this.scaleMin = 5.0;
                this.scaleMax = 6.0;
                this.chartHeight = 100;
                this.line1Height = 75;
                this.line2Height = 90;
                this.totalTime = 120;
                this.remainingTime = this.totalTime;
                this.progressBar = document.querySelector('.progress');
                this.timeDisplay = document.querySelector('.ratio');
                this.pressTimes = [];
                this.frequencyThresholdHigh = 110;
                this.frequencyThresholdLow = 90;
                this.startMonitoring();
                this.startCountdown();
            }
    
            depthToHeight(depth) {
                const heightRange = this.chartHeight;
                const depthRange = this.scaleMax - this.scaleMin;
                const scaleFactor = heightRange / depthRange;
                return depth * (this.line1Height / this.scaleMin);
            }
    
            getPressType(depth) {
                if (depth > this.scaleMax) return 'danger';
                if (depth < this.scaleMin) return 'warning';
                return 'success';
            }
    
            updateChart() {
                const depth = this.generatePressDepth();
                const type = this.getPressType(depth);
                const height = this.depthToHeight(depth);
                this.pressData.unshift({ depth: depth, type: type, height: height });
                if (this.pressData.length > this.maxBars) {
                    this.pressData.pop();
                }
                this.chart.innerHTML = '';
                this.pressData.forEach(press => {
                    const bar = document.createElement('div');
                    bar.className = `bar ${press.type}`;
                    bar.style.height = `${press.height}px`;
                    this.chart.appendChild(bar);
                });
                this.updateWarnings();
            }
    
            generatePressDepth() {
                return 4.5 + Math.random() * 2;
            }
    
            calculateFrequency(interval) {
                return 60000 / interval;
            }
    
            updateWarnings() {
                const warningContainer = document.querySelector('.warnings');
                warningContainer.innerHTML = '';
                if (this.pressData.length > 0) {
                    const latestPress = this.pressData[0];
                    if (latestPress.type === 'danger') {
                        warningContainer.appendChild(document.createElement('span')).textContent = '按压过深！';
                    } else if (latestPress.type === 'warning') {
                        warningContainer.appendChild(document.createElement('span')).textContent = '按压过浅！';
                    } else {
                        warningContainer.appendChild(document.createElement('span')).textContent = '按压正常！';
                    }
                }
                const frequency = this.calculateFrequency(this.currentInterval);
                if (frequency > this.frequencyThresholdHigh) {
                    warningContainer.appendChild(document.createElement('span')).textContent = '按压频率过快！';
                } else if (frequency < this.frequencyThresholdLow) {
                    warningContainer.appendChild(document.createElement('span')).textContent = '按压频率过慢！';
                } else {
                    warningContainer.appendChild(document.createElement('span')).textContent = '按压频率正常！';
                }
            }
    
            startMonitoring() {
                this.updateChart();
                const randomIntervals = [666, 1000, 800, 600, 550, 500, 400, 200, 545];
                const updateFunc = () => {
                    if (this.remainingTime <= 0) return;
                    this.updateChart();
                    this.currentInterval = randomIntervals[Math.floor(Math.random() * randomIntervals.length)];
                    setTimeout(updateFunc, this.currentInterval);
                };
                updateFunc();
            }
    
            startCountdown() {
                this.updateCountdown();
                const countdownInterval = setInterval(() => {
                    this.remainingTime -= 1;
                    if (this.remainingTime <= 0) {
                        clearInterval(countdownInterval);
                        this.remainingTime = 0;
                        this.updateCountdown();
                        return;
                    }
                    this.updateCountdown();
                }, 1000);
            }
    
            updateCountdown() {
                const progress = (this.remainingTime / this.totalTime) * 100;
                this.progressBar.style.width = `${progress}%`;
                const minutes = Math.floor(this.remainingTime / 60);
                const seconds = this.remainingTime % 60;
                this.timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
    
            resetCountdown() {
                this.remainingTime = this.totalTime;
                this.updateCountdown();
                this.startCountdown();
            }
        }
    
        // 除颤模块的随机显示功能
        class DefibrillationModule {
            constructor() {
                this.shockCountElement = document.querySelector('.shock-count');
                this.energyElement = document.querySelector('.energy-value');
                this.energyDisplayElement = document.querySelector('.energy-display-value');
                this.waitingMessage = document.querySelector('.waiting-message');
                this.warningMessage = document.querySelector('.warning-message');
                this.setInitialValues();
                this.startMonitoring();
            }
    
            setInitialValues() {
                // 随机生成电击次数，范围是1-3次
                const shockCount = Math.floor(Math.random() * 3) + 1; // 修改这里，使范围变为1-3

                // 能量值在60J和150J之间二选一
                const energyOptions = [60, 150];
                const energyIndex = Math.floor(Math.random() * energyOptions.length); // 生成0或1的索引
                const energy = energyOptions[energyIndex]; // 根据索引选择能量值

                // 设置元素内容
                this.shockCountElement.textContent = `${shockCount}次`;
                this.energyElement.textContent = `${energy}J`;
                this.energyDisplayElement.textContent = energy;
            }
    
            startMonitoring() {
                const randomTime = Math.floor(Math.random() * 120000); // 随机生成一个时间点（0-120秒）
                setTimeout(() => {
                    this.generateDefibrillationSignal();
                }, randomTime);
            }
    
            generateDefibrillationSignal() {
                const shouldGenerateSignal = Math.random() > 0.5; // 50% 的概率生成信号
                if (shouldGenerateSignal) {
                    this.waitingMessage.style.display = 'none';
                    this.warningMessage.style.display = 'block';
                }
            }
        }
    
        window.addEventListener('load', () => {
            new CPRMonitor();
            new DefibrillationModule();
        });

        let currentStyle = null;
        let styleStartTime = null;
        let compressionInterval = null;
        let countdownInterval = null;
        let remainingTime = 120; // 2分钟 = 120秒

        // 添加倒计时显示
        function createCountdownDisplay() {
            const countdownDiv = document.createElement('div');
            countdownDiv.id = 'countdown';
            countdownDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                border-radius: 5px;
                font-size: 24px;
                font-weight: bold;
                z-index: 1000;
            `;
            document.body.appendChild(countdownDiv);
            updateCountdown(remainingTime);
        }

        // 更新倒计时显示
        function updateCountdown(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const display = document.getElementById('countdown');
            if (display) {
                display.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // 开始倒计时
        function startCountdown() {
            // 清除现有倒计时
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // 重置时间
            remainingTime = 120;
            updateCountdown(remainingTime);
            
            // 开始新的倒计时
            countdownInterval = setInterval(() => {
                remainingTime--;
                updateCountdown(remainingTime);
                
                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    clearInterval(compressionInterval);
                    isCompressing = false;
                    currentDepth = 0;
                    updateVisualization();
                }
            }, 1000);
        }

        // 修改设置按压风格的函数
        function setCompressionStyle(styleId) {
            // 清除现有的定时器
            if (compressionInterval) {
                clearInterval(compressionInterval);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // 重置状态
            currentStyle = compressionStyles[styleId];
            styleStartTime = Date.now();
            isCompressing = false;
            currentDepth = 0;
            
            console.log(`切换到按压风格${styleId}, 转换时间: ${currentStyle.transitionTime/1000}秒`);
            
            // 重新开始按压和倒计时
            startCompression();
            startCountdown();
        }

        // 开始按压的函数
        function startCompression() {
            // 确保只有一个按压循环在运行
            if (compressionInterval) {
                clearInterval(compressionInterval);
            }
            
            // 重置按压状态
            isCompressing = false;
            currentDepth = 0;
            
            // 开始新的按压循环
            compress();
            
            // 设置新的按压间隔
            compressionInterval = setInterval(() => {
                compress();
            }, getRandomInterval());
        }

        // 修改compress函数
        function compress() {
            if (isCompressing) return;
            
            isCompressing = true;
            const targetDepth = generatePressDepth();
            
            // 动画压缩
            const animation = setInterval(() => {
                if (currentDepth < targetDepth) {
                    currentDepth += 0.5;
                    updateVisualization();
                } else {
                    clearInterval(animation);
                    // 开始释放
                    release();
                }
            }, 20);
        }

        // 修改release函数
        function release() {
            const animation = setInterval(() => {
                if (currentDepth > 0) {
                    currentDepth -= 0.5;
                    updateVisualization();
                } else {
                    clearInterval(animation);
                    isCompressing = false;
                    
                    // 更新下一次按压的间隔
                    if (compressionInterval) {
                        clearInterval(compressionInterval);
                        compressionInterval = setInterval(() => {
                            compress();
                        }, getRandomInterval());
                    }
                }
            }, 20);
        }

        // 修改按钮添加函数
        function addStyleButtons() {
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1000;
            `;

            const styles = [
                { name: "风格1: 浅快→正常 (15s)", id: 1 },
                { name: "风格2: 深慢→正常 (20s)", id: 2 },
                { name: "风格3: 正常→浅慢 (15s)", id: 3 },
                { name: "风格4: 正常→深慢 (15s)", id: 4 },
                { name: "风格5: 正常→深慢 (20s)", id: 5 }
            ];

            let activeButton = null;

            styles.forEach(style => {
                const button = document.createElement('button');
                button.textContent = style.name;
                button.style.cssText = `
                    padding: 10px;
                    margin: 5px;
                    cursor: pointer;
                    background-color: #2196F3;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    width: 200px;
                    transition: background-color 0.3s;
                `;
                
                button.onclick = () => {
                    if (activeButton) {
                        activeButton.style.backgroundColor = '#2196F3';
                    }
                    button.style.backgroundColor = '#1565C0';
                    activeButton = button;
                    setCompressionStyle(style.id);
                };
                
                buttonContainer.appendChild(button);
            });

            document.body.appendChild(buttonContainer);
        }

        // 定义不同的按压参数
        const compressionStyles = {
            // 浅快→正常 (15s)
            1: {
                initial: {
                    depth: { min: 3, max: 4 },      // 过浅
                    interval: { min: 300, max: 400 } // 过快
                },
                normal: {
                    depth: { min: 4.5, max: 6.5 },  // 正常
                    interval: { min: 500, max: 600 } // 正常
                },
                transitionTime: 15000
            },
            // 深慢→正常 (20s)
            2: {
                initial: {
                    depth: { min: 6.5, max: 7.5 },  // 过深
                    interval: { min: 700, max: 800 } // 过慢
                },
                normal: {
                    depth: { min: 4.5, max: 6.5 },  // 正常
                    interval: { min: 500, max: 600 } // 正常
                },
                transitionTime: 20000
            },
            // 正常→浅慢 (15s)
            3: {
                initial: {
                    depth: { min: 4.5, max: 6.5 },  // 正常
                    interval: { min: 500, max: 600 } // 正常
                },
                normal: {
                    depth: { min: 3, max: 4 },      // 过浅
                    interval: { min: 700, max: 800 } // 过慢
                },
                transitionTime: 15000
            },
            // 正常→深慢 (15s)
            4: {
                initial: {
                    depth: { min: 4.5, max: 6.5 },  // 正常
                    interval: { min: 500, max: 600 } // 正常
                },
                normal: {
                    depth: { min: 6.5, max: 7.5 },  // 过深
                    interval: { min: 700, max: 800 } // 过慢
                },
                transitionTime: 15000
            },
            // 正常→深慢 (20s)
            5: {
                initial: {
                    depth: { min: 4.5, max: 6.5 },  // 正常
                    interval: { min: 500, max: 600 } // 正常
                },
                normal: {
                    depth: { min: 6.5, max: 7.5 },  // 过深
                    interval: { min: 700, max: 800 } // 过慢
                },
                transitionTime: 20000
            }
        };

        // 修改生成按压深度的函数
        Chart.prototype.generatePressDepth = function() {
            if (!this.currentStyle) {
                return 4.5 + Math.random() * 2; // 默认正常深度
            }

            const elapsed = Date.now() - this.styleStartTime;
            const style = compressionStyles[this.currentStyle];
            let depthRange;
            
            if (elapsed < style.transitionTime) {
                depthRange = style.initial.depth;
            } else {
                depthRange = style.normal.depth;
            }
            
            // 在范围内生成深度
            const depth = depthRange.min + Math.random() * (depthRange.max - depthRange.min);
            console.log(`当前深度: ${depth.toFixed(2)}, 范围: ${depthRange.min}-${depthRange.max}`);
            return depth;
        };

        // 修改获取随机间隔的函数
        Chart.prototype.getRandomInterval = function() {
            if (!this.currentStyle) {
                return 500 + Math.random() * 100; // 默认正常频率
            }

            const style = compressionStyles[this.currentStyle];
            let intervalRange;
            
            if (elapsed < style.transitionTime) {
                intervalRange = style.initial.interval;
            } else {
                intervalRange = style.normal.interval;
            }
            
            return intervalRange.min + Math.random() * (intervalRange.max - intervalRange.min);
        };

        // 修改Chart类的calculateFrequency方法
        Chart.prototype.calculateFrequency = function(interval) {
            return 60000 / interval;
        };

        // 在初始化时创建倒计时显示
        document.addEventListener('DOMContentLoaded', () => {
            addStyleButtons();
            createCountdownDisplay();
        });

        // 在Chart类中修改按钮点击事件
        Chart.prototype.addStyleButtons = function() {
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1000;
            `;

            const styles = [
                { name: "风格1: 浅快→正常 (15s)", id: 1 },
                { name: "风格2: 深慢→正常 (20s)", id: 2 },
                { name: "风格3: 正常→浅慢 (15s)", id: 3 },
                { name: "风格4: 正常→深慢 (15s)", id: 4 },
                { name: "风格5: 正常→深慢 (20s)", id: 5 }
            ];

            let activeButton = null;

            styles.forEach(style => {
                const button = document.createElement('button');
                button.textContent = style.name;
                button.style.cssText = `
                    padding: 10px;
                    margin: 5px;
                    cursor: pointer;
                    background-color: #2196F3;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    width: 200px;
                    transition: background-color 0.3s;
                    font-size: 14px;
                `;
                
                button.onclick = () => {
                    // 更新按钮状态
                    document.querySelectorAll('button').forEach(b => {
                        b.style.backgroundColor = '#2196F3';
                    });
                    button.style.backgroundColor = '#1565C0';
                    
                    // 设置新的风格
                    this.setCompressionStyle(style.id);
                };
                
                buttonContainer.appendChild(button);
            });

            document.body.appendChild(buttonContainer);
        };

        // 在Chart类的构造函数中添加风格初始化
        function Chart(container) {
            // ... 现有的构造函数代码 ...
            this.currentStyle = null;
            this.styleStartTime = null;
            this.interval = null;
            this.initialize();
        }

        // 修改setCompressionStyle方法
        Chart.prototype.setCompressionStyle = function(styleId) {
            console.log(`设置按压风格: ${styleId}`);
            
            // 停止当前动画
            this.stop();
            
            // 重置状态
            this.pressData = [];
            this.chart.innerHTML = '';
            this.currentStyle = styleId;
            this.styleStartTime = Date.now();
            
            // 重新开始
            this.startAnimation();
            this.startCountdown();
        };

        // 新增startAnimation方法
        Chart.prototype.startAnimation = function() {
            if (this.interval) {
                clearInterval(this.interval);
            }
            
            const updateWithStyle = () => {
                // 获取当前风格
                const style = compressionStyles[this.currentStyle];
                const elapsed = Date.now() - this.styleStartTime;
                const intervalRange = elapsed < style.transitionTime ? 
                    style.initial.interval : 
                    style.normal.interval;
                    
                // 更新图表
                this.updateChart();
                
                // 设置下一次更新的间隔
                const nextInterval = intervalRange.min + 
                    Math.random() * (intervalRange.max - intervalRange.min);
                    
                console.log(`当前间隔: ${nextInterval.toFixed(0)}ms`);
                
                this.interval = setTimeout(updateWithStyle, nextInterval);
            };
            
            // 立即开始第一次更新
            updateWithStyle();
        };

        // 修改stop方法
        Chart.prototype.stop = function() {
            if (this.interval) {
                clearInterval(this.interval);
                clearTimeout(this.interval);
                this.interval = null;
            }
            if (this.countdownInterval) {
                clearInterval(this.countdownInterval);
                this.countdownInterval = null;
            }
        };

        // 修改updateChart方法
        Chart.prototype.updateChart = function() {
            const depth = this.generatePressDepth();
            const type = this.getPressType(depth);
            const height = this.depthToHeight(depth);
            
            this.pressData.unshift({ depth: depth, type: type, height: height });
            if (this.pressData.length > this.maxBars) {
                this.pressData.pop();
            }
            
            this.chart.innerHTML = '';
            this.pressData.forEach(press => {
                const bar = document.createElement('div');
                bar.className = `bar ${press.type}`;
                bar.style.height = `${press.height}px`;
                this.chart.appendChild(bar);
            });
            
            this.updateWarnings();
        };
    </script>
</body>
</html>